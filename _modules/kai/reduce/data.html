<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kai.reduce.data &mdash; KAI  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            KAI
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">KAI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">kai.reduce.data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kai.reduce.data</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">pyraf</span> <span class="kn">import</span> <span class="n">iraf</span> <span class="k">as</span> <span class="n">ir</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">kai_util</span>
<span class="kn">from</span> <span class="nn">kai.reduce</span> <span class="kn">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">lin_correction</span>
<span class="kn">from</span> <span class="nn">kai</span> <span class="kn">import</span> <span class="n">instruments</span>
<span class="kn">from</span> <span class="nn">kai</span> <span class="kn">import</span> <span class="n">strehl</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dar</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bfixpix</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<div class="viewcode-block" id="module_dir">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.module_dir">[docs]</a>
<span class="n">module_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span></div>


<div class="viewcode-block" id="supermaskName">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.supermaskName">[docs]</a>
<span class="n">supermaskName</span> <span class="o">=</span> <span class="s1">&#39;supermask.fits&#39;</span></div>

<div class="viewcode-block" id="outputVerify">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.outputVerify">[docs]</a>
<span class="n">outputVerify</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span></div>


<div class="viewcode-block" id="clean">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean">[docs]</a>
<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">nite</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">refSrc</span><span class="p">,</span> <span class="n">strSrc</span><span class="p">,</span>
        <span class="n">dark_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">badColumns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skyscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angOff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">cent_box</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_koa_weather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">raw_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span> <span class="n">check_ref_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ref_offset_method</span><span class="o">=</span><span class="s1">&#39;aotsxy&#39;</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean near infrared NIRC2 or OSIRIS images.</span>

<span class="sd">    This program should be run from the reduce/ directory.</span>
<span class="sd">    Example directory structure is:</span>
<span class="sd">    calib/</span>
<span class="sd">        flats/</span>
<span class="sd">        flat_kp.fits</span>
<span class="sd">        flat.fits (optional)</span>
<span class="sd">        masks/</span>
<span class="sd">        supermask.fits</span>
<span class="sd">    kp/</span>
<span class="sd">        sci_nite1/</span>
<span class="sd">        sky_nite1/</span>
<span class="sd">        sky.fits</span>

<span class="sd">    All output files will be put into clean_dir (if specified, otherwise</span>
<span class="sd">    ../clean/) in the following structure:</span>
<span class="sd">    kp/</span>
<span class="sd">        c*.fits</span>
<span class="sd">        distort/</span>
<span class="sd">        cd*.fits</span>
<span class="sd">        weight/</span>
<span class="sd">        wgt*.fits</span>

<span class="sd">    The clean directory may be optionally modified to be named</span>
<span class="sd">    &lt;field_&gt;&lt;wave&gt; instead of just &lt;wave&gt;. So for instance, for Arches</span>
<span class="sd">    field #1 data reduction, you might call clean with: field=&#39;arch_f1&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list of int</span>
<span class="sd">        Integer list of the files. Does not require padded zeros.</span>
<span class="sd">    nite : str</span>
<span class="sd">        Name for night of observation (e.g.: &quot;nite1&quot;), used as suffix</span>
<span class="sd">        inside the reduce sub-directories.</span>
<span class="sd">    wave : str</span>
<span class="sd">        Name for the observation passband (e.g.: &quot;kp&quot;), used as</span>
<span class="sd">        a wavelength suffix</span>
<span class="sd">    refSrc : [float, float]</span>
<span class="sd">        x and y coordinates for the reference source, provided as a list of two</span>
<span class="sd">        float coordinates.</span>
<span class="sd">    strSrc : [float, float]</span>
<span class="sd">        x and y coordinates for the Strehl source, provided as a list of two</span>
<span class="sd">        float coordinates.</span>
<span class="sd">    dark_frame : str, default=None</span>
<span class="sd">        File name for the dark frame in order to carry out dark correction.</span>
<span class="sd">        If not provided, dark frame is not subtracted and a warning is thrown.</span>
<span class="sd">        Assumes dark file is located under ./calib/darks/</span>
<span class="sd">    field : str, default=None</span>
<span class="sd">        Optional prefix for clean directory and final</span>
<span class="sd">        combining. All clean files will be put into &lt;field_&gt;&lt;wave&gt;. You</span>
<span class="sd">        should also pass the same into combine(). If set to None (default)</span>
<span class="sd">        then only wavelength is used.</span>
<span class="sd">    skyscale : bool, default=False</span>
<span class="sd">        Whether or not to scale the sky files to the common median.</span>
<span class="sd">        Turn on for scaling skies before subtraction.</span>
<span class="sd">    skyfile : str, default=&#39;&#39;</span>
<span class="sd">        An optional file containing image/sky matches.</span>
<span class="sd">    angOff : float, default = 0</span>
<span class="sd">        An optional absolute offset in the rotator</span>
<span class="sd">        mirror angle for cases (wave=&#39;lp&#39;) when sky subtraction is done with</span>
<span class="sd">        skies taken at matching rotator mirror angles.</span>
<span class="sd">    cent_box : int (def = 12)</span>
<span class="sd">        the box to use for better centroiding the reference star</span>
<span class="sd">    badColumns : int array, default = None</span>
<span class="sd">        An array specifying the bad columns (zero-based).</span>
<span class="sd">        Assumes a repeating pattern every 8 columns.</span>
<span class="sd">    fixDAR : boolean, default = True</span>
<span class="sd">        Whether or not to calculate DAR correction coefficients.</span>
<span class="sd">    use_koa_weather : boolean, default = False</span>
<span class="sd">        If calculating DAR correction, this keyword specifies if the atmosphere</span>
<span class="sd">        conditions should be downloaded from the KOA weather data. If False,</span>
<span class="sd">        atmosphere conditions are downloaded from the MKWC CFHT data.</span>
<span class="sd">    raw_dir : str, optional</span>
<span class="sd">        Directory where raw files are stored. By default,</span>
<span class="sd">        assumes that raw files are stored in &#39;../raw&#39;</span>
<span class="sd">    clean_dir : str, optional</span>
<span class="sd">        Directory where clean files will be stored. By default,</span>
<span class="sd">        assumes that clean files will be stored in &#39;../clean&#39;</span>
<span class="sd">    instrument : instruments object, optional</span>
<span class="sd">        Instrument of data. Default is `instruments.default_inst`</span>
<span class="sd">    ref_offset_method : str, default=&#39;aotsxy&#39;</span>
<span class="sd">        Method to calculate offsets from reference image.</span>
<span class="sd">        Options are &#39;aotsxy&#39; or &#39;radec&#39;.</span>
<span class="sd">        In images where &#39;aotsxy&#39; keywords aren&#39;t reliable, &#39;radec&#39; calculated</span>
<span class="sd">        offsets may work better.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Make sure directory for current passband exists and switch into it</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
    
    <span class="c1"># Determine directory locatons</span>
    <span class="n">waveDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="n">redDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">waveDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">rootDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="n">sciDir</span> <span class="o">=</span> <span class="n">waveDir</span> <span class="o">+</span> <span class="s1">&#39;/sci_&#39;</span> <span class="o">+</span> <span class="n">nite</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">sciDir</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="n">sciDir</span><span class="p">)</span>

    <span class="c1"># Set location of raw data</span>
    <span class="n">rawDir</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;raw/&#39;</span>
    
    <span class="c1"># Check if user has specified a specific raw directory</span>
    <span class="k">if</span> <span class="n">raw_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rawDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">raw_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="c1"># Setup the clean directory</span>
    <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;clean/&#39;</span>
    
    <span class="c1"># Check if user has specified a specific clean directory</span>
    <span class="k">if</span> <span class="n">clean_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">clean_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    
    <span class="n">distort</span> <span class="o">=</span> <span class="n">clean</span> <span class="o">+</span> <span class="s1">&#39;distort/&#39;</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">clean</span> <span class="o">+</span> <span class="s1">&#39;weight/&#39;</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="n">clean</span> <span class="o">+</span> <span class="s1">&#39;masks/&#39;</span>
    
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cleanRoot</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">distort</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
    
    <span class="c1"># Open a text file to document sources of data files</span>
    <span class="n">data_sources_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">clean</span> <span class="o">+</span> <span class="s1">&#39;data_sources.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Setup flat. Try wavelength specific, but if it doesn&#39;t</span>
        <span class="c1"># exist, then use a global one.</span>
        <span class="n">flatDir</span> <span class="o">=</span> <span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;calib/flats/&#39;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">flatDir</span> <span class="o">+</span> <span class="s1">&#39;flat_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="n">flatDir</span> <span class="o">+</span> <span class="s1">&#39;flat.fits&#39;</span>

        <span class="c1"># Bad pixel mask</span>
        <span class="n">_supermask</span> <span class="o">=</span> <span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;calib/masks/&#39;</span> <span class="o">+</span> <span class="n">supermaskName</span>

        <span class="c1"># Determine the reference coordinates for the first image.</span>
        <span class="c1"># This is the image for which refSrc is relevant.</span>
        <span class="n">firstFile</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">rawDir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hdr1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">firstFile</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">radecRef</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">])]</span>
        <span class="n">aotsxyRef</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">getAotsxy</span><span class="p">(</span><span class="n">hdr1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref_offset_method</span> <span class="o">==</span> <span class="s1">&#39;pcu&#39;</span><span class="p">:</span>
            <span class="n">pcuxyRef</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_pcuxyRef</span><span class="p">(</span><span class="n">hdr1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcuxyRef</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Setup a Sky object that will figure out the sky subtraction</span>
        <span class="n">skyDir</span> <span class="o">=</span> <span class="n">waveDir</span> <span class="o">+</span> <span class="s1">&#39;sky_&#39;</span> <span class="o">+</span> <span class="n">nite</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">skyObj</span> <span class="o">=</span> <span class="n">Sky</span><span class="p">(</span><span class="n">sciDir</span><span class="p">,</span> <span class="n">skyDir</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">skyscale</span><span class="p">,</span>
                     <span class="n">skyfile</span><span class="o">=</span><span class="n">skyfile</span><span class="p">,</span> <span class="n">angleOffset</span><span class="o">=</span><span class="n">angOff</span><span class="p">,</span>
                     <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

        <span class="c1"># Prep drizzle stuff</span>
        <span class="c1"># Get image size from header - this is just in case the image</span>
        <span class="c1"># isn&#39;t 1024x1024 (e.g., NIRC2 sub-arrays). Also, if it&#39;s</span>
        <span class="c1"># rectangular, choose the larger dimension and make it square</span>
        <span class="n">imgsizeX</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>
        <span class="n">imgsizeY</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span>

        <span class="n">distXgeoim</span><span class="p">,</span> <span class="n">distYgeoim</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_distortion_maps</span><span class="p">(</span><span class="n">hdr1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imgsizeX</span> <span class="o">&gt;=</span> <span class="n">imgsizeY</span><span class="p">):</span>
            <span class="n">imgsize</span> <span class="o">=</span> <span class="n">imgsizeX</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imgsize</span> <span class="o">=</span> <span class="n">imgsizeY</span>
        <span class="n">setup_drizzle</span><span class="p">(</span><span class="n">imgsize</span><span class="p">)</span>
        
        <span class="c1"># Read in dark frame data</span>
        <span class="c1"># Throw warning if dark frame not provided for dark correction</span>
        <span class="k">if</span> <span class="n">dark_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dark_file</span> <span class="o">=</span> <span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;/calib/darks/&#39;</span> <span class="o">+</span> <span class="n">dark_frame</span>
            
            <span class="c1"># Read in dark frame data</span>
            <span class="n">dark_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dark_file</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;Dark frame not provided for clean().&#39;</span>
            <span class="n">warning_message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cleaning without dark subtraction.&#39;</span>
        
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>
        
        <span class="c1">##########</span>
        <span class="c1"># Loop through the list of images</span>
        <span class="c1">##########</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># Define filenames</span>
            <span class="n">_raw</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">rawDir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_cp</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_ss</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_ff</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;ff&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_ff_f</span> <span class="o">=</span> <span class="n">_ff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_f.fits&#39;</span><span class="p">)</span>
            <span class="n">_ff_s</span> <span class="o">=</span> <span class="n">_ff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_s.fits&#39;</span><span class="p">)</span>
            <span class="n">_bp</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;bp&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_cd</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;cd&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_ce</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;ce&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_cc</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_wgt</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;wgt&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_statmask</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;stat_mask&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_crmask</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;crmask&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_mask</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_pers</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pers&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="n">_cc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.max&#39;</span><span class="p">)</span>
            <span class="n">_coo</span> <span class="o">=</span> <span class="n">_cc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.coo&#39;</span><span class="p">)</span>
            <span class="n">_rcoo</span> <span class="o">=</span> <span class="n">_cc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.rcoo&#39;</span><span class="p">)</span>
            <span class="n">_dlog_tmp</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">([</span><span class="n">f</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;driz&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_dlog</span> <span class="o">=</span> <span class="n">_dlog_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
            
            <span class="n">out_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> from </span><span class="si">{1}</span><span class="s1"> (</span><span class="si">{2}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cc</span><span class="p">,</span> <span class="n">_raw</span><span class="p">,</span>
                                                     <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">data_sources_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_line</span><span class="p">)</span>

            <span class="c1"># Clean up if these files previously existed</span>
            <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span>
                <span class="n">_cp</span><span class="p">,</span> <span class="n">_ss</span><span class="p">,</span> <span class="n">_ff</span><span class="p">,</span> <span class="n">_ff_f</span><span class="p">,</span> <span class="n">_ff_s</span><span class="p">,</span> <span class="n">_bp</span><span class="p">,</span> <span class="n">_cd</span><span class="p">,</span> <span class="n">_ce</span><span class="p">,</span> <span class="n">_cc</span><span class="p">,</span>
                <span class="n">_wgt</span><span class="p">,</span> <span class="n">_statmask</span><span class="p">,</span> <span class="n">_crmask</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_pers</span><span class="p">,</span> <span class="n">_max</span><span class="p">,</span> <span class="n">_coo</span><span class="p">,</span>
                <span class="n">_rcoo</span><span class="p">,</span> <span class="n">_dlog</span><span class="p">,</span>
            <span class="p">])</span>

            <span class="c1">### Copy the raw file to local directory ###</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">imcopy</span><span class="p">(</span><span class="n">_raw</span><span class="p">,</span> <span class="n">_cp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
            
            <span class="c1">### Make persistance mask ###</span>
            <span class="c1"># - Checked images, this doesn&#39;t appear to be a large effect.</span>
            <span class="c1">#clean_persistance(_cp, _pers, instrument=instrument)</span>
            
            <span class="c1"># Dark correction</span>
            <span class="k">if</span> <span class="n">dark_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="n">output_verify</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> 
                <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur_frame</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">cur_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">frame_header</span> <span class="o">=</span> <span class="n">cur_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="n">frame_data</span> <span class="o">=</span> <span class="n">frame_data</span> <span class="o">-</span> <span class="n">dark_data</span>
                <span class="n">frame_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">frame_data</span><span class="p">,</span> 
                <span class="n">header</span><span class="o">=</span><span class="n">frame_header</span><span class="p">)</span>
                <span class="n">frame_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> 
                <span class="n">output_verify</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> 
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Linearity correction</span>
            <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="s1">&#39;NIRC2&#39;</span><span class="p">:</span>
                <span class="n">lin_correction</span><span class="o">.</span><span class="n">lin_correction</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
            
            <span class="c1">### Sky subtract ###</span>
            <span class="c1"># Get the proper sky for this science frame.</span>
            <span class="c1"># It might be scaled or there might be a specific one for L&#39;.</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">skyObj</span><span class="o">.</span><span class="n">getSky</span><span class="p">(</span><span class="n">_cp</span><span class="p">)</span>

            <span class="n">ir</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">sky</span><span class="p">,</span> <span class="n">_ss</span><span class="p">)</span>

            <span class="c1">### Flat field ###</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">_ss</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="p">,</span> <span class="n">_ff</span><span class="p">)</span>
            
            <span class="c1">### Make a static bad pixel mask ###</span>
            <span class="c1"># _statmask = supermask + bad columns</span>
            <span class="n">clean_get_supermask</span><span class="p">(</span><span class="n">_statmask</span><span class="p">,</span> <span class="n">_supermask</span><span class="p">,</span> <span class="n">badColumns</span><span class="p">)</span>

            <span class="c1">### Fix bad pixels ###</span>
            <span class="c1"># Produces _ff_f file</span>
            <span class="n">bfixpix</span><span class="o">.</span><span class="n">bfixpix</span><span class="p">(</span><span class="n">_ff</span><span class="p">,</span> <span class="n">_statmask</span><span class="p">)</span>
            <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_ff_s</span><span class="p">])</span>

            <span class="c1">### Fix cosmic rays and make cosmic ray mask. ###</span>
            <span class="n">clean_cosmicrays</span><span class="p">(</span><span class="n">_ff_f</span><span class="p">,</span> <span class="n">_crmask</span><span class="p">,</span> <span class="n">wave</span><span class="p">)</span>

            <span class="c1">### Combine static and cosmic ray mask ###</span>
            <span class="c1"># This will be used in combine later on.</span>
            <span class="c1"># Results are stored in _mask, _mask_static is deleted.</span>
            <span class="n">clean_makemask</span><span class="p">(</span><span class="n">_mask</span><span class="p">,</span> <span class="n">_crmask</span><span class="p">,</span> <span class="n">_statmask</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

            <span class="c1">### Background Subtraction ###</span>
            <span class="n">bkg</span> <span class="o">=</span> <span class="n">clean_bkgsubtract</span><span class="p">(</span><span class="n">_ff_f</span><span class="p">,</span> <span class="n">_bp</span><span class="p">)</span>

            <span class="c1">### Drizzle individual file ###</span>
            <span class="n">clean_drizzle</span><span class="p">(</span><span class="n">distXgeoim</span><span class="p">,</span> <span class="n">distYgeoim</span><span class="p">,</span> <span class="n">_bp</span><span class="p">,</span> <span class="n">_ce</span><span class="p">,</span> <span class="n">_wgt</span><span class="p">,</span> <span class="n">_dlog</span><span class="p">,</span>
                          <span class="n">fixDAR</span><span class="o">=</span><span class="n">fixDAR</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                          <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>

            <span class="c1">### Make .max file ###</span>
            <span class="c1"># Determine the non-linearity level. Raw data level of</span>
            <span class="c1"># non-linearity is 12,000 but we subtracted</span>
            <span class="c1"># off a sky which changed this level. The sky is</span>
            <span class="c1"># scaled, so the level will be slightly different</span>
            <span class="c1"># for every frame.</span>
            <span class="n">nonlinSky</span> <span class="o">=</span> <span class="n">skyObj</span><span class="o">.</span><span class="n">getNonlinearCorrection</span><span class="p">(</span><span class="n">sky</span><span class="p">)</span>

            <span class="n">coadds</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">_ss</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;coadds&#39;</span><span class="p">])</span>
            <span class="n">satLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">coadds</span><span class="o">*</span><span class="n">instrument</span><span class="o">.</span><span class="n">get_saturation_level</span><span class="p">())</span> <span class="o">-</span> <span class="n">nonlinSky</span> <span class="o">-</span> <span class="n">bkg</span>
            <span class="n">file</span><span class="p">(</span><span class="n">_max</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">satLevel</span><span class="p">))</span>

            <span class="c1">### Rename and clean up files ###</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">imrename</span><span class="p">(</span><span class="n">_bp</span><span class="p">,</span> <span class="n">_cd</span><span class="p">)</span>
            <span class="c1"># util.rmall([_cp, _ss, _ff, _ff_f])</span>

            <span class="c1">### Make the *.coo file and update headers ###</span>
            <span class="c1"># First check if PA is not zero</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_raw</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

            <span class="n">clean_makecoo</span><span class="p">(</span><span class="n">_ce</span><span class="p">,</span> <span class="n">_cc</span><span class="p">,</span> <span class="n">refSrc</span><span class="p">,</span> <span class="n">strSrc</span><span class="p">,</span> <span class="n">aotsxyRef</span><span class="p">,</span> <span class="n">radecRef</span><span class="p">,</span>
                          <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="n">check_ref_loc</span><span class="p">,</span>
                          <span class="n">cent_box</span><span class="o">=</span><span class="n">cent_box</span><span class="p">,</span> <span class="n">offset_method</span><span class="o">=</span><span class="n">ref_offset_method</span><span class="p">,</span><span class="n">pcuxyRef</span><span class="o">=</span><span class="n">pcuxyRef</span><span class="p">)</span>

            <span class="c1">### Move to the clean directory ###</span>
            <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">clean</span> <span class="o">+</span> <span class="n">_cc</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_coo</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_rcoo</span><span class="p">,</span>
                        <span class="n">distort</span> <span class="o">+</span> <span class="n">_cd</span><span class="p">,</span> <span class="n">weight</span> <span class="o">+</span> <span class="n">_wgt</span><span class="p">,</span>
                        <span class="n">clean</span> <span class="o">+</span> <span class="n">_ce</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_max</span><span class="p">,</span>
                        <span class="n">masks</span> <span class="o">+</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">_ce</span><span class="p">])</span>

            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_cc</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_cc</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_cd</span><span class="p">,</span> <span class="n">distort</span> <span class="o">+</span> <span class="n">_cd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_wgt</span><span class="p">,</span> <span class="n">weight</span> <span class="o">+</span> <span class="n">_wgt</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_mask</span><span class="p">,</span> <span class="n">masks</span> <span class="o">+</span> <span class="n">_mask</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_max</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_max</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_coo</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_coo</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_rcoo</span><span class="p">,</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">_rcoo</span><span class="p">)</span>

            <span class="c1"># This just closes out any sky logging files.</span>
            <span class="c1">#skyObj.close()</span>
        <span class="n">data_sources_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Move back up to the original directory</span>
        <span class="c1">#skyObj.close()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">redDir</span><span class="p">)</span>

    <span class="c1"># Change back to original directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">redDir</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_get_supermask">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_get_supermask">[docs]</a>
<span class="k">def</span> <span class="nf">clean_get_supermask</span><span class="p">(</span><span class="n">_statmask</span><span class="p">,</span> <span class="n">_supermask</span><span class="p">,</span> <span class="n">badColumns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create temporary mask for each individual image that will contain the</span>
<span class="sd">    supermask plus the designated bad columns.</span>

<span class="sd">    _statmask -- output file containing supermask + bad columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">maskFits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_supermask</span><span class="p">)</span>

    <span class="c1"># Check that we have some valid bad columns.</span>
    <span class="k">if</span> <span class="n">badColumns</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">badColumns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">badColumns</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Make column index from 0-512 n steps of 8</span>
            <span class="n">colIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">maskFits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">,</span><span class="n">colIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Save to a temporary file.</span>
    <span class="n">maskFits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_statmask</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_makemask">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_makemask">[docs]</a>
<span class="k">def</span> <span class="nf">clean_makemask</span><span class="p">(</span><span class="n">_mask</span><span class="p">,</span> <span class="n">_mask_cosmic</span><span class="p">,</span> <span class="n">_mask_static</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span>
                   <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    _mask -- output name for final mask</span>
<span class="sd">    _mask_cosmic -- should contain cosmic ray mask</span>
<span class="sd">    _mask_static -- should contain supermask + bad columns</span>

<span class="sd">    Output:</span>
<span class="sd">    _mask is created to be supermask + bad columns + cosmic rays</span>
<span class="sd">    _mask will have 0=bad and 1=good pixels (as drizzle expects)</span>
<span class="sd">    _mask can be directly passed into drizzle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the masks to combine</span>
    <span class="n">staticMask</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_mask_static</span><span class="p">)</span>
    <span class="n">cosmicMask</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_mask_cosmic</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">staticMask</span> <span class="o">+</span> <span class="n">cosmicMask</span>

    <span class="c1"># check subarray</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NIRC2&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;lp&#39;</span> <span class="ow">in</span> <span class="n">wave</span> <span class="ow">or</span> <span class="s1">&#39;ms&#39;</span> <span class="ow">in</span> <span class="n">wave</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">):</span>
        <span class="n">_lpmask</span> <span class="o">=</span> <span class="n">module_dir</span> <span class="o">+</span> <span class="s1">&#39;/masks/nirc2_lp_edgemask.fits&#39;</span>
        <span class="n">lpmask</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_lpmask</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">+=</span> <span class="n">lpmask</span>

    <span class="c1"># Set to 0 or 1 -- note they are inverted</span>
    <span class="n">weightone</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">weightzero</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Drizzle expects 0 = bad, 1 = good pixels.</span>
    <span class="n">outMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">outMask</span><span class="p">[</span><span class="n">weightone</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">outMask</span><span class="p">[</span><span class="n">weightzero</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Trim 12 rows from top and bottom b/c the distortion solution</span>
    <span class="c1"># introduces a torque to the image.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NIRC2&#39;</span><span class="p">):</span>
        <span class="n">outMask</span><span class="p">[</span><span class="mi">1012</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outMask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Write out to file</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_mask</span><span class="p">,</span> <span class="n">outMask</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span></div>

    <span class="c1">#outMask[0].writeto(_mask, output_verify=outputVerify)</span>


<div class="viewcode-block" id="clean_lp">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_lp">[docs]</a>
<span class="k">def</span> <span class="nf">clean_lp</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">nite</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">refSrc</span><span class="p">,</span> <span class="n">strSrc</span><span class="p">,</span> <span class="n">angOff</span><span class="p">,</span> <span class="n">skyfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Only here for backwards compatability.</span>
<span class="sd">    You should use clean() instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clean</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">nite</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">refSrc</span><span class="p">,</span> <span class="n">strSrc</span><span class="p">,</span>
          <span class="n">angOff</span><span class="o">=</span><span class="n">angOff</span><span class="p">,</span> <span class="n">skyfile</span><span class="o">=</span><span class="n">skyfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="combine">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine">[docs]</a>
<span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outSuffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">trim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwhm_max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">submaps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_koa_weather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">clean_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">combo_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span>
           <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accepts a list of cleaned images and does a weighted combining after</span>
<span class="sd">    performing frame selection based on the Strehl and FWHM.</span>
<span class="sd">    </span>
<span class="sd">    Each image must have an associated *.coo file which gives the rough</span>
<span class="sd">    position of the reference source.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list of int</span>
<span class="sd">        Integer list of the files to include in combine. Does not require</span>
<span class="sd">        padded zeros.</span>
<span class="sd">    wave : str</span>
<span class="sd">        Name for the observation passband (e.g.: &quot;kp&quot;, &quot;lp&quot;, or &quot;h&quot;), used as</span>
<span class="sd">        a wavelength suffix</span>
<span class="sd">    outroot : str</span>
<span class="sd">        The output root name (e.g. &#39;06jullgs&#39;). The final combined file names</span>
<span class="sd">        will be &lt;outroot&gt;_&lt;field&gt;_&lt;outSuffix&gt;_&lt;wave&gt;.</span>
<span class="sd">        The &lt;field&gt; and &lt;outSuffix&gt; keywords are optional.</span>
<span class="sd">        </span>
<span class="sd">        Examples:</span>
<span class="sd">        06jullgs_kp for outroot=&#39;06jullgs&#39; and wave=&#39;kp&#39;</span>
<span class="sd">        06jullgs_arch_f1_kp for adding field=&#39;arch_f1&#39;</span>
<span class="sd">    field : str, default=None</span>
<span class="sd">        Optional field name. Used to get to clean directory and also affects</span>
<span class="sd">        the final output file name.</span>
<span class="sd">    outSuffix : str</span>
<span class="sd">        Optional suffix used to modify final output file name.</span>
<span class="sd">        Can use suffix to indicate a night of observation (e.g.: &quot;nite1&quot;).</span>
<span class="sd">    trim : bool, default=False</span>
<span class="sd">        Optional file trimming based on image quality. Default</span>
<span class="sd">        is False. Set to True to turn trimming on.</span>
<span class="sd">    weight : str, default=None</span>
<span class="sd">        Optional weighting. Set to &#39;strehl&#39; to weight by Strehl, as found in</span>
<span class="sd">        strehl_source.txt file.</span>
<span class="sd">        OR set to a file name with the first column being the file name</span>
<span class="sd">        (e.g., c0021.fits) and the second column being the weight. Weights will</span>
<span class="sd">        be renormalized to sum to 1.0.</span>
<span class="sd">        Default = None, no weighting.</span>
<span class="sd">    fwhm_max : float, default=0</span>
<span class="sd">        The maximum allowed FWHM for keeping frames when trimming is turned on.</span>
<span class="sd">    submaps : int, default=0</span>
<span class="sd">        Set to the number of submaps to be made (def=0).</span>
<span class="sd">    fixDAR : boolean, default = True</span>
<span class="sd">        Whether or not to calculate and apply DAR correction coefficients.</span>
<span class="sd">    use_koa_weather : boolean, default = False</span>
<span class="sd">        If calculating DAR correction, this keyword specifies if the atmosphere</span>
<span class="sd">        conditions should be downloaded from the KOA weather data. If False,</span>
<span class="sd">        atmosphere conditions are downloaded from the MKWC CFHT data.</span>
<span class="sd">    mask : bool, default=True</span>
<span class="sd">    clean_dirs : list of str, optional</span>
<span class="sd">        List of directories where clean files are stored. Needs to be same</span>
<span class="sd">        length as files list. If not specified, by default assumes that</span>
<span class="sd">        clean files are stored in &#39;../clean&#39;.</span>
<span class="sd">    combo_dir : str, optional</span>
<span class="sd">        Directory where combo files will be stored. By default,</span>
<span class="sd">        assumes that combo files will be stored in &#39;../combo&#39;</span>
<span class="sd">    instrument : instruments object, optional</span>
<span class="sd">        Instrument of data. Default is `instruments.default_inst`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Setup some files and directories</span>
    <span class="n">redDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">rootDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="c1"># Determine clean directory and add field and suffixes to outroot</span>
    <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;clean/&#39;</span>
    
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">outroot</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">field</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    
    <span class="c1"># If clean directories are specified for each file,</span>
    <span class="c1"># first tack on the field and wave to each path</span>
    <span class="k">if</span> <span class="n">clean_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If incorrect number of clean directories specified, raise ValueError</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_dirs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">err_str</span> <span class="o">=</span> <span class="s1">&#39;Length of clean_dirs needs to match number of files, &#39;</span>
            <span class="n">err_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
            
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>
        
        <span class="c1"># Tack on field and wave to each path</span>
        <span class="k">for</span> <span class="n">clean_dir_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_dirs</span><span class="p">)):</span>
            <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">clean_dirs</span><span class="p">[</span><span class="n">clean_dir_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clean_dirs</span><span class="p">[</span><span class="n">clean_dir_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span>\
                                              <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clean_dirs</span><span class="p">[</span><span class="n">clean_dir_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">outSuffix</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outroot</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">outSuffix</span>
    
    <span class="c1"># Set up combo directory. This is the final output directory.</span>
    <span class="n">comboDir</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;combo/&#39;</span>
    
    <span class="k">if</span> <span class="n">combo_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comboDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">combo_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">comboDir</span><span class="p">)</span>
    
    
    <span class="c1"># Make strings out of all the filename roots.</span>
    <span class="n">allroots</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">allroots</span> <span class="o">=</span> <span class="p">[</span><span class="n">aa</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">allroots</span><span class="p">]</span>
    
    <span class="c1"># If clean directories were specified for each file, copy over</span>
    <span class="c1"># clean files to a common clean directory into new combo directory</span>
    <span class="k">if</span> <span class="n">clean_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Save and make new clean directory, inside the new combo directory</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">comboDir</span> <span class="o">+</span> <span class="s1">&#39;clean/&#39;</span>
        
        <span class="n">field_wave_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_wave_suffix</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_wave_suffix</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        
        <span class="n">cleanDir</span> <span class="o">+=</span> <span class="n">field_wave_suffix</span>
        
        <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;distort/&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;masks/&#39;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;weight/&#39;</span><span class="p">)</span>
        
        <span class="c1"># Determine all unique clean directories, which we&#39;ll be sourcing from</span>
        <span class="p">(</span><span class="n">unique_clean_dirs</span><span class="p">,</span>
         <span class="n">unique_clean_dirs_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clean_dirs</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">c_lis_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c.lis&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">data_sources_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;data_sources.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="c1"># Go through each clean file and copy over the data files</span>
        <span class="k">for</span> <span class="n">cur_file_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
            <span class="n">cur_file_root</span> <span class="o">=</span> <span class="n">allroots</span><span class="p">[</span><span class="n">cur_file_index</span><span class="p">]</span>
            
            <span class="n">source_clean_dir</span> <span class="o">=</span> <span class="n">unique_clean_dirs</span><span class="p">[</span>
                <span class="n">unique_clean_dirs_index</span><span class="p">[</span><span class="n">cur_file_index</span><span class="p">]]</span>
            <span class="n">source_file_root</span> <span class="o">=</span> <span class="n">cur_file_root</span>
            
            <span class="c1"># Change first digit of file names to be index of clean dir</span>
            <span class="c1"># i.e.: unique 1000s place digit for each night going into combo</span>
            <span class="n">allroots</span><span class="p">[</span><span class="n">cur_file_index</span><span class="p">]</span> <span class="o">=</span>\
                <span class="nb">str</span><span class="p">(</span><span class="n">unique_clean_dirs_index</span><span class="p">[</span><span class="n">cur_file_index</span><span class="p">])</span> <span class="o">+</span> <span class="n">cur_file_root</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="n">dest_clean_dir</span> <span class="o">=</span> <span class="n">cleanDir</span>
            <span class="n">dest_file_root</span> <span class="o">=</span> <span class="n">allroots</span><span class="p">[</span><span class="n">cur_file_index</span><span class="p">]</span>
            
            <span class="c1"># Copy data files</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span><span class="p">)</span>
            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">)</span>
            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;distort/cd&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;distort/cd&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;masks/mask&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;masks/mask&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;weight/wgt&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                        <span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;weight/wgt&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            
            <span class="c1"># Append file to c.lis and text list of data sources</span>
            <span class="n">c_lis_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dest_clean_dir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">out_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> from </span><span class="si">{1}{2}</span><span class="s1"> (</span><span class="si">{3}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">dest_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                <span class="n">source_clean_dir</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">source_file_root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">data_sources_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_line</span><span class="p">)</span>
        
        <span class="n">c_lis_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">data_sources_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Copy over strehl source list(s) from clean directories</span>
        
        <span class="c1"># Need to rename file names in list to new names</span>
        <span class="n">out_strehl_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;strehl_source.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="c1"># Go through each clean directory&#39;s strehl_source file</span>
        <span class="k">for</span> <span class="n">cur_clean_dir_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_clean_dirs</span><span class="p">)):</span>
            
            <span class="c1"># Open existing Strehl file in clean directory</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">unique_clean_dirs</span><span class="p">[</span><span class="n">cur_clean_dir_index</span><span class="p">]</span> <span class="o">+</span>
                      <span class="s1">&#39;strehl_source.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_strehl_file</span><span class="p">:</span>
                
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_strehl_file</span><span class="p">:</span>
                    <span class="c1"># Check for header line</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t skip header if it is first clean directory</span>
                        <span class="k">if</span> <span class="n">cur_clean_dir_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">out_strehl_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            
                        <span class="c1"># Otherwise skip to next line</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Correct file names and write to overall strehl file</span>
                    <span class="n">corrected_line</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur_clean_dir_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">out_strehl_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">corrected_line</span><span class="p">)</span>
        
        <span class="n">out_strehl_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># Make a deep copy of all the root filenames    </span>
    <span class="n">roots</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">allroots</span><span class="p">)</span> <span class="c1"># This one will be modified by trimming</span>
    
    <span class="c1"># This is the output root filename</span>
    <span class="n">_out</span> <span class="o">=</span> <span class="n">comboDir</span> <span class="o">+</span> <span class="s1">&#39;mag&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span>
    <span class="n">_sub</span> <span class="o">=</span> <span class="n">comboDir</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span>
    
    <span class="c1">##########</span>
    <span class="c1"># Determine if we are going to trim and/or weight the files</span>
    <span class="c1"># when combining. If so, then we need to determine the Strehl</span>
    <span class="c1"># and FWHM for each image. We check strehl source which shouldn&#39;t</span>
    <span class="c1"># be saturated. *** Hard coded to strehl source ***</span>
    <span class="c1">##########</span>

    <span class="c1"># Load the strehl_source.txt file</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span><span class="s1">&#39;strehl_source.txt&#39;</span><span class="p">))):</span>
        <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span> <span class="o">=</span> <span class="n">loadStrehl</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if the file doesn&#39;t exist don&#39;t use</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: the strehl_source file does not exist: &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span><span class="s1">&#39;strehl_source.txt&#39;</span><span class="p">))</span>

        <span class="c1"># fill out some variables for later use</span>
        <span class="n">strehls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">))</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">trim</span> <span class="o">=</span> <span class="kc">False</span>
    

    <span class="c1"># Default weights</span>
    <span class="c1"># Create an array with length equal to number of frames used,</span>
    <span class="c1"># and with all elements equal to 1/(# of files)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Trimming</span>
    <span class="c1">##########</span>
    <span class="k">if</span> <span class="n">trim</span><span class="p">:</span>
        <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">trim_on_fwhm</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span>
                                                     <span class="n">fwhm_max</span><span class="o">=</span><span class="n">fwhm_max</span><span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Weighting</span>
    <span class="c1">##########</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="s1">&#39;strehl&#39;</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weight_by_strehl</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;strehl&#39;</span><span class="p">)):</span>
        <span class="c1"># Assume weight is set to a filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weight</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Weights file does not exist, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">weight</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Weights file: &#39;</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">readWeightsFile</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

    <span class="c1"># Determine the reference image</span>
    <span class="c1"># refImage_index = 0    # Use the first image from night</span>
    <span class="n">refImage_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>    <span class="c1"># Use the lowest FWHM frame</span>
    <span class="n">refImage</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">refImage_index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: reference image - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">refImage</span><span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Write out a log file. With a list of images in the</span>
    <span class="c1"># final combination.</span>
    <span class="c1">##########</span>
    <span class="n">combine_log</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

    <span class="c1"># See if all images are at same PA, if not, rotate all to PA = 0</span>
    <span class="c1"># temporarily. This needs to be done to get correct shifts.</span>
    <span class="n">diffPA</span> <span class="o">=</span> <span class="n">combine_rotation</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

    <span class="c1"># Make a table of coordinates for the reference source.</span>
    <span class="c1"># These serve as initial estimates for the shifts.</span>
    <span class="c1">#combine_ref(_out + &#39;.coo&#39;, cleanDir, roots, diffPA, refImage_index)</span>
    <span class="n">combine_coo</span><span class="p">(</span><span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">refImage_index</span><span class="p">)</span>

    <span class="c1"># Keep record of files that went into this combine</span>
    <span class="n">combine_lis</span><span class="p">(</span><span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.lis&#39;</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">)</span>

    <span class="c1"># Register images to get shifts.</span>
    <span class="n">shiftsTab</span> <span class="o">=</span> <span class="n">combine_register</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">)</span>

    <span class="c1"># Determine the size of the output image from max shifts</span>
    <span class="n">xysize</span> <span class="o">=</span> <span class="n">combine_size</span><span class="p">(</span><span class="n">shiftsTab</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">_out</span><span class="p">,</span> <span class="n">_sub</span><span class="p">,</span> <span class="n">submaps</span><span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Sort frames -- recall that submaps assume sorted by FWHM.</span>
    <span class="c1">##########</span>
    <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shiftsTab</span> <span class="o">=</span> <span class="n">sort_frames</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shiftsTab</span><span class="p">)</span>

    <span class="c1"># Combine all the images together.</span>
    <span class="n">combine_drizzle</span><span class="p">(</span><span class="n">xysize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">_out</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shiftsTab</span><span class="p">,</span>
                    <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">fixDAR</span><span class="o">=</span><span class="n">fixDAR</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                    <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>

    <span class="c1"># Now make submaps</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">submaps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">combine_submaps</span><span class="p">(</span><span class="n">xysize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">_sub</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span>
                        <span class="n">shiftsTab</span><span class="p">,</span> <span class="n">submaps</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">fixDAR</span><span class="o">=</span><span class="n">fixDAR</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                        <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>

    <span class="c1"># Remove *.lis_r file &amp; rotated rcoo files, if any - these</span>
    <span class="c1"># were just needed to get the proper shifts for xregister</span>
    <span class="n">_lisr</span> <span class="o">=</span> <span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.lis_r&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_lisr</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allroots</span><span class="p">)):</span>
        <span class="n">_rcoo</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">allroots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.rcoo&#39;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_rcoo</span><span class="p">])</span>
    
    <span class="c1"># Change back to original directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">redDir</span><span class="p">)</span></div>


<div class="viewcode-block" id="rot_img">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.rot_img">[docs]</a>
<span class="k">def</span> <span class="nf">rot_img</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate images to PA=0 if they have a different PA from one</span>
<span class="sd">    another. If the entire data set is taken at a single PA, leave</span>
<span class="sd">    it as is. Do this only if set includes various PAs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">unlearn</span><span class="p">(</span><span class="s1">&#39;rotate&#39;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="s1">&#39;constant&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">interpolant</span> <span class="o">=</span> <span class="s1">&#39;spline3&#39;</span>

    <span class="n">inCln</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">outCln</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;r&#39;</span> <span class="o">+</span> <span class="n">root</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">outCln</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">phi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rotating frame: &#39;</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">inCln</span><span class="p">,</span> <span class="n">outCln</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">imcopy</span><span class="p">(</span><span class="n">inCln</span><span class="p">,</span> <span class="n">outCln</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="gcSourceXY">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.gcSourceXY">[docs]</a>
<span class="k">def</span> <span class="nf">gcSourceXY</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">label_file</span><span class="o">=</span><span class="s1">&#39;/Users/jlu/data/gc/source_list/label.dat&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries label.dat for the xy offset from Sgr A* (in arcsec)</span>
<span class="sd">    for the star given as an input</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of a star (e.g. &#39;irs16NE&#39;)</span>
<span class="sd">    label_file : str, default=&#39;/Users/jlu/data/gc/source_list/label.dat&#39;</span>
<span class="sd">        Full path of label.dat file to search</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pos : float list (2 elements)</span>
<span class="sd">        x and y offset from Sgr A* in arcsec</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read in label.dat</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">label_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">nameCol</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nameCol</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not find source &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; in label.dat.&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span></div>



<div class="viewcode-block" id="calcStrehl">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.calcStrehl">[docs]</a>
<span class="k">def</span> <span class="nf">calcStrehl</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span>
               <span class="n">clean_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make Strehl and FWHM table on the strehl source for all</span>
<span class="sd">    cleaned files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list of int</span>
<span class="sd">        Integer list of the files. Does not require padded zeros.</span>
<span class="sd">    wave : str</span>
<span class="sd">        Name for the observation passband (e.g.: &quot;kp&quot;), used as</span>
<span class="sd">        a wavelength suffix</span>
<span class="sd">    field : str, default=None</span>
<span class="sd">        Optional prefix for clean directory and final</span>
<span class="sd">        combining. All clean files will be put into &lt;field_&gt;&lt;wave&gt;. You</span>
<span class="sd">        should also pass the same into combine(). If set to None (default)</span>
<span class="sd">        then only wavelength is used.</span>
<span class="sd">    clean_dir : str, optional</span>
<span class="sd">        Directory where clean files will be stored. By default,</span>
<span class="sd">        assumes that clean files will be stored in &#39;../clean&#39;</span>
<span class="sd">    instrument : instruments object, optional</span>
<span class="sd">        Instrument of data. Default is `instruments.default_inst`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Make sure directory for current passband exists and switch into it</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
    
    <span class="c1"># Determine directory locatons</span>
    <span class="n">waveDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">redDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">waveDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">rootDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    
    <span class="c1"># Setup the clean directory</span>
    <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;clean/&#39;</span>
    
    <span class="c1"># Check if user has specified a specific clean directory</span>
    <span class="k">if</span> <span class="n">clean_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cleanRoot</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">clean_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">cleanRoot</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    
    
    <span class="c1"># Make a list of all the images</span>
    <span class="n">clis_file</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c.lis&#39;</span>
    <span class="n">strehl_file</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;strehl_source.txt&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">clis_file</span><span class="p">,</span> <span class="n">strehl_file</span><span class="p">])</span>

    <span class="n">clean_files</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="c1"># Keep a record of the cleaned files. </span>
    <span class="n">_clis</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">clis_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clean_files</span><span class="p">:</span>
        <span class="n">_clis</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">_clis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Calculate Strehl, FWHM</span>
    <span class="n">strehl</span><span class="o">.</span><span class="n">calc_strehl</span><span class="p">(</span><span class="n">clean_files</span><span class="p">,</span> <span class="n">strehl_file</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
    
    <span class="c1"># Check that the number of lines in the resulting strehl file</span>
    <span class="c1"># matches the number of images we have. If not, some of the images</span>
    <span class="c1"># are bad and were dropped.</span>
    <span class="n">strehlTable</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">strehl_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">strehlTable</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strehlTable</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_files</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">strehlTable</span><span class="p">))</span>
        <span class="c1"># Figure out the dropped files.</span>
        <span class="n">droppedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">clean_files</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cc</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">foundIt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">strehlTable</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">:</span>
                    <span class="n">foundIt</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">foundIt</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">droppedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;calcStrehl: Strehl widget lost files: &#39;</span><span class="p">,</span>
                           <span class="n">droppedFiles</span><span class="p">)</span>
    
    <span class="c1"># Switch back to parent directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">redDir</span><span class="p">)</span></div>


<div class="viewcode-block" id="weight_by_strehl">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.weight_by_strehl">[docs]</a>
<span class="k">def</span> <span class="nf">weight_by_strehl</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate weights based on the strehl of each image.</span>
<span class="sd">    This does some intelligent handling for REALLY bad data quality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set negative Strehls to the lowest detected strehl.</span>
    <span class="n">bidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">strehls</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">strehls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">badroots</span> <span class="o">=</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bidx</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found files with incorrect Strehl. May be incorrectly&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;weighted. Setting weights to minimum weight. &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">badroots</span><span class="p">))</span>

    <span class="n">strehl_min</span> <span class="o">=</span> <span class="n">strehls</span><span class="p">[</span><span class="n">gidx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">strehls</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">strehl_min</span>

    <span class="c1"># Now determine a fractional weight</span>
    <span class="n">wgt_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">strehls</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">strehls</span> <span class="o">/</span> <span class="n">wgt_tot</span>

    <span class="k">return</span> <span class="n">weights</span></div>



<div class="viewcode-block" id="trim_on_fwhm">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.trim_on_fwhm">[docs]</a>
<span class="k">def</span> <span class="nf">trim_on_fwhm</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">fwhm_max</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take a list of files and trim based on the FWHM. All files that have a</span>
<span class="sd">    FWHM &lt; 1.25 * FWHM.min()</span>
<span class="sd">    are kept.</span>

<span class="sd">    The returned arrays contain only those files that pass the above criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Trim level (fwhm) can be passed in or determined</span>
    <span class="c1"># dynamically.</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fwhm_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Determine the minimum FWHM</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fwhm_min</span> <span class="o">=</span> <span class="n">fwhm</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Maximum allowed FWHM to keep frame</span>
        <span class="n">fwhm_max</span> <span class="o">=</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">fwhm_min</span>

    <span class="c1"># Pull out those we want to include in the combining</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">fwhm</span> <span class="o">&lt;=</span> <span class="n">fwhm_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">strehls</span> <span class="o">=</span> <span class="n">strehls</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: Keeping </span><span class="si">%d</span><span class="s1"> frames with FWHM &lt; </span><span class="si">%4.1f</span><span class="s1">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">),</span> <span class="n">fwhm_max</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span></div>



<div class="viewcode-block" id="readWeightsFile">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.readWeightsFile">[docs]</a>
<span class="k">def</span> <span class="nf">readWeightsFile</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">weightFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expects a file of the format:</span>
<span class="sd">    column1 = file name (e.g. c0001.fits).</span>
<span class="sd">    column2 = weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weightsTable</span> <span class="o">=</span> <span class="n">trim_table_by_name</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">weightFile</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">weightsTable</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Renormalize so that weights add up to 1.0</span>
    <span class="n">weights</span> <span class="o">/=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="c1"># Double check that we have the same number of</span>
    <span class="c1"># lines in the weightsTable as files.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong number of lines in  &#39;</span> <span class="o">+</span> <span class="n">weightFile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span></div>



<div class="viewcode-block" id="loadStrehl">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.loadStrehl">[docs]</a>
<span class="k">def</span> <span class="nf">loadStrehl</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load Strehl and FWHM info. The file format will be</span>
<span class="sd">    column1 = name of cleaned fits file (e.g. c0001.fits).</span>
<span class="sd">              Expects single character before a 4 digit number.</span>
<span class="sd">    column2 = strehl</span>
<span class="sd">    column3 = RMS error (nm)</span>
<span class="sd">    column4 = FWHM (mas)</span>
<span class="sd">    column5 = MJD (UT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_strehl</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;strehl_source.txt&#39;</span>
    
    <span class="c1"># Read in file and get strehls and FWHMs</span>
    <span class="n">strehlTable</span> <span class="o">=</span> <span class="n">trim_table_by_name</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">_strehl</span><span class="p">)</span>
    <span class="n">strehls</span> <span class="o">=</span> <span class="n">strehlTable</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">strehlTable</span><span class="p">[</span><span class="s1">&#39;col4&#39;</span><span class="p">]</span>
    
    <span class="c1"># Double check that we have the same number of</span>
    <span class="c1"># lines in the strehlTable as files.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strehls</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wrong number of lines in  &#39;</span> <span class="o">+</span> <span class="n">_strehl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span></div>


<div class="viewcode-block" id="trim_table_by_name">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.trim_table_by_name">[docs]</a>
<span class="k">def</span> <span class="nf">trim_table_by_name</span><span class="p">(</span><span class="n">outroots</span><span class="p">,</span> <span class="n">tableFileName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list of values (listed in tableFileName) and trim them down based on</span>
<span class="sd">    the desired output list of root files names (outroots).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tableFileName</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outroots</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">outroots</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">good</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">newtable</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">newtable</span></div>



<div class="viewcode-block" id="combine_drizzle">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_drizzle">[docs]</a>
<span class="k">def</span> <span class="nf">combine_drizzle</span><span class="p">(</span><span class="n">imgsize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span>
                    <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_koa_weather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span>
                   <span class="p">):</span>
    <span class="n">_fits</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">_tmpfits</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_tmp.fits&#39;</span>
    <span class="n">_wgt</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_sig.fits&#39;</span>
    <span class="n">_dlog</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_driz.log&#39;</span>
    <span class="n">_maxFile</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span>

    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_fits</span><span class="p">,</span> <span class="n">_tmpfits</span><span class="p">,</span> <span class="n">_wgt</span><span class="p">,</span> <span class="n">_dlog</span><span class="p">])</span>

    <span class="c1"># Make directory for individually drizzled and pre-shifted images.</span>
    <span class="c1">#util.mkdir(cleanDir + &#39;shifted&#39;)</span>

    <span class="c1"># Prep drizzle stuff</span>
    <span class="n">setup_drizzle</span><span class="p">(</span><span class="n">imgsize</span><span class="p">)</span>

    <span class="c1"># BUG: with context... when many files are drizzled</span>
    <span class="c1"># together, a new, bigger context file is created, but this</span>
    <span class="c1"># fails with a Bus error.</span>
    <span class="c1">#ir.drizzle.outcont = _ctx</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outcont</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">fillval</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">satLvl_combo</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Set a cleanDir variable in IRAF. This avoids the long-filename problem.</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cleanDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">)</span>
    
    <span class="c1"># Variable to store weighted sum of MJDs</span>
    <span class="n">mjd_weightedSum</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Get the distortion maps for this instrument.</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">distXgeoim</span><span class="p">,</span> <span class="n">distYgeoim</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_distortion_maps</span><span class="p">(</span><span class="n">hdr0</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: drizzling images together&#39;</span><span class="p">)</span>
    <span class="n">f_dlog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dlog</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="c1"># Cleaned image</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">_c_ir</span> <span class="o">=</span> <span class="n">_c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>

        <span class="c1"># Cleaned but distorted image</span>
        <span class="n">_cd</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;distort/cd&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">_cdwt</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;weight/cdwt.fits&#39;</span>
        <span class="n">_cd_ir</span> <span class="o">=</span> <span class="n">_cd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
        <span class="n">_cdwt_ir</span> <span class="o">=</span> <span class="n">_cdwt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>

        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_cdwt</span><span class="p">])</span>

        <span class="c1"># Multiply each distorted image by it&#39;s weight</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">_cd_ir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_cdwt_ir</span><span class="p">)</span>

        <span class="c1"># Fix the ITIME header keyword so that it matches (weighted).</span>
        <span class="c1"># Drizzle will add all the ITIMEs together, just as it adds the flux.</span>
        <span class="n">itime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">_cdwt</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;itime&#39;</span><span class="p">])</span>
        <span class="n">itime</span> <span class="o">*=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">_cdwt</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;itime&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">itime</span><span class="p">)</span>

        <span class="c1"># Get pixel shifts</span>
        <span class="n">xsh</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ysh</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Read in PA of each file to feed into drizzle for rotation</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_c</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">rot</span> <span class="o">=</span> <span class="n">phi</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fixDAR</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">darRoot</span> <span class="o">=</span> <span class="n">_cdwt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">xgeoim</span><span class="p">,</span> <span class="n">ygeoim</span><span class="p">)</span> <span class="o">=</span> <span class="n">dar</span><span class="o">.</span><span class="n">darPlusDistortion</span><span class="p">(</span>
                                   <span class="n">_cdwt</span><span class="p">,</span> <span class="n">darRoot</span><span class="p">,</span>
                                   <span class="n">xgeoim</span><span class="o">=</span><span class="n">distXgeoim</span><span class="p">,</span>
                                   <span class="n">ygeoim</span><span class="o">=</span><span class="n">distYgeoim</span><span class="p">,</span>
                                   <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                                   <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>

            <span class="n">xgeoim</span> <span class="o">=</span> <span class="n">xgeoim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
            <span class="n">ygeoim</span> <span class="o">=</span> <span class="n">ygeoim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">xgeoim</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">ygeoim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">distXgeoim</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">distYgeoim</span>

        
        <span class="c1"># Read in MJD of current file from FITS header</span>
        <span class="n">mjd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">])</span>
        <span class="n">mjd_weightedSum</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mjd</span>
        
        <span class="c1"># Drizzle this file ontop of all previous ones.</span>
        <span class="n">f_dlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">_mask</span> <span class="o">=</span> <span class="s1">&#39;cleanDir$masks/mask&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">in_mask</span> <span class="o">=</span> <span class="n">_mask</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outweig</span> <span class="o">=</span> <span class="n">_wgt</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xsh</span> <span class="o">=</span> <span class="n">xsh</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ysh</span> <span class="o">=</span> <span class="n">ysh</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outnx</span> <span class="o">=</span> <span class="n">imgsize</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outny</span> <span class="o">=</span> <span class="n">imgsize</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drizzling: &#39;</span><span class="p">,</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     xsh = </span><span class="si">{0:8.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">xsh</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     ysh = </span><span class="si">{0:8.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">ysh</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  weight = </span><span class="si">{0:8.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   outnx = </span><span class="si">{0:8d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">imgsize</span> <span class="p">))</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="p">(</span><span class="n">_cdwt_ir</span><span class="p">,</span> <span class="n">_tmpfits</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="n">f_dlog</span><span class="p">)</span>

        <span class="c1"># Read .max file with saturation level for final combined image</span>
        <span class="c1"># by weighting each individual satLevel and summing.</span>
        <span class="c1"># Read in each satLevel from individual .max files</span>
        <span class="n">_max</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span>
        <span class="c1">#getsatLvl = Table.read(_max, format=&#39;ascii.no_header&#39;) #changed from , header_start=None</span>
        <span class="c1">#satLvl = getsatLvl[0][0]</span>
        <span class="n">getsatLvl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_max</span><span class="p">)</span>
        <span class="n">satLvl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">getsatLvl</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">getsatLvl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">satLvl_wt</span> <span class="o">=</span> <span class="n">satLvl</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">satLvl_combo</span> <span class="o">+=</span> <span class="n">satLvl_wt</span>

    <span class="n">f_dlog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;satLevel for combo image = &#39;</span><span class="p">,</span> <span class="n">satLvl_combo</span><span class="p">)</span>
    <span class="c1"># Write the combo saturation level to a file</span>
    <span class="n">_max</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_maxFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">_max</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%15.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">satLvl_combo</span><span class="p">)</span>
    <span class="n">_max</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Clean up the drizzled image of any largely negative values.</span>
    <span class="c1"># Don&#39;t do this! See how starfinder handles really negative pixels,</span>
    <span class="c1"># and if all goes well...don&#39;t ever correct negative pixels to zero.</span>
    <span class="n">fits_f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_tmpfits</span><span class="p">)</span>
    
    <span class="n">tmp_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sci_mean</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sci_stddev</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Find and fix really bad pixels</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sci_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="n">sci_stddev</span><span class="p">))</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="n">sci_stddev</span>

    <span class="c1"># Set the ROTPOSN value for the combined image.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ROTPOSN&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">phi</span><span class="p">,</span>
                              <span class="s1">&#39;rotator user position&#39;</span><span class="p">)</span>

    <span class="c1"># Add keyword with distortion image information</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DISTORTX&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">distXgeoim</span><span class="p">,</span>
                          <span class="s1">&#39;X Distortion Image&#39;</span><span class="p">)</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DISTORTY&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">distYgeoim</span><span class="p">,</span>
                          <span class="s1">&#39;Y Distortion Image&#39;</span><span class="p">)</span>

    <span class="c1"># Fix the DATASEC header keyword, if it exists.</span>
    <span class="k">if</span> <span class="s1">&#39;DATASEC&#39;</span> <span class="ow">in</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATASEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[1:</span><span class="si">{0:d}</span><span class="s1">,1:</span><span class="si">{0:d}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imgsize</span><span class="p">)</span>
    
    <span class="c1"># Calculate weighted MJD and store in header</span>
    <span class="n">mjd_weightedMean</span> <span class="o">=</span> <span class="n">mjd_weightedSum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mjd_weightedMean</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="s1">&#39;MJD-OBS&#39;</span><span class="p">,</span> <span class="n">mjd_weightedMean</span><span class="p">,</span>
        <span class="s1">&#39;Weighted modified julian date of combined observations&#39;</span>
    <span class="p">)</span>
    
    <span class="c1">## Also update date field in header</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="s1">&#39;DATE&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_obs</span><span class="o">.</span><span class="n">fits</span><span class="p">),</span>
        <span class="s1">&#39;Weighted observation date&#39;</span>
    <span class="p">)</span>
    
    
    <span class="c1"># Save to final fits file.</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_fits</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_tmpfits</span><span class="p">,</span> <span class="n">_cdwt</span><span class="p">])</span></div>


<div class="viewcode-block" id="combine_submaps">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_submaps">[docs]</a>
<span class="k">def</span> <span class="nf">combine_submaps</span><span class="p">(</span>
        <span class="n">imgsize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span>
        <span class="n">shifts</span><span class="p">,</span> <span class="n">submaps</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span>
        <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_koa_weather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assumes the list of roots are pre-sorted based on quality. Images are then</span>
<span class="sd">          divided up with every Nth image going into the Nth submap.</span>

<span class="sd">    mask: (def=True) Set to false for maser mosaics since they have only</span>
<span class="sd">          one image at each positions. Masking produces artifacts that</span>
<span class="sd">          Starfinder can&#39;t deal with.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">extend</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">,</span> <span class="s1">&#39;_3&#39;</span><span class="p">]</span>
    <span class="n">_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">outroot</span> <span class="o">+</span> <span class="n">end</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">extend</span><span class="p">]</span>
    <span class="n">_fits</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_out</span><span class="p">]</span>
    <span class="n">_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="s1">&#39;_tmp.fits&#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_out</span><span class="p">]</span>
    <span class="n">_wgt</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="s1">&#39;_sig.fits&#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_out</span><span class="p">]</span>
    <span class="n">_log</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="s1">&#39;_driz.log&#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_out</span><span class="p">]</span>
    <span class="n">_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">_out</span><span class="p">]</span>

    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">(</span><span class="n">_fits</span> <span class="o">+</span> <span class="n">_tmp</span> <span class="o">+</span> <span class="n">_wgt</span> <span class="o">+</span> <span class="n">_log</span> <span class="o">+</span> <span class="n">_max</span><span class="p">)</span>

    <span class="c1"># Prep drizzle stuff</span>
    <span class="n">setup_drizzle</span><span class="p">(</span><span class="n">imgsize</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drizzle imgsize = &#39;</span><span class="p">,</span> <span class="n">imgsize</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outcont</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">satLvl_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">submaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">satLvl_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">submaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: drizzling sub-images together&#39;</span><span class="p">)</span>
    <span class="n">f_log</span> <span class="o">=</span> <span class="p">[</span><span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">_log</span><span class="p">]</span>

    <span class="c1"># Final normalization factor</span>
    <span class="n">weightsTot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">submaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Array to store weighted sum of MJDs in each submap</span>
    <span class="n">mjd_weightedSums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">submaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Get the distortion maps for this instrument.</span>
    <span class="n">hdr0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
    <span class="n">distXgeoim</span><span class="p">,</span> <span class="n">distYgeoim</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_distortion_maps</span><span class="p">(</span><span class="n">hdr0</span><span class="p">)</span>

    <span class="c1"># Set a cleanDir variable in IRAF. This avoids the long-filename problem.</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cleanDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="c1"># Cleaned image</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">_c_ir</span> <span class="o">=</span> <span class="n">_c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>

        <span class="c1"># Cleaned but distorted image</span>
        <span class="n">_cd</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;distort/cd&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">cdwt</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;weight/cdwt.fits&#39;</span>
        <span class="n">_cd_ir</span> <span class="o">=</span> <span class="n">_cd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
        <span class="n">_cdwt_ir</span> <span class="o">=</span> <span class="n">cdwt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>

        <span class="c1"># Multiply each distorted image by it&#39;s weight</span>
        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">cdwt</span><span class="p">])</span>

        <span class="n">ir</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">_cd</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_cdwt_ir</span><span class="p">)</span>
        
        <span class="c1"># Fix the ITIME header keyword so that it matches (weighted).</span>
        <span class="c1"># Drizzle will add all the ITIMEs together, just as it adds the flux.</span>
        <span class="n">itime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">cdwt</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;itime&#39;</span><span class="p">])</span>
        <span class="n">itime</span> <span class="o">*=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="n">cdwt</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;itime&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">itime</span><span class="p">)</span>
        
        <span class="c1"># Get pixel shifts</span>
        <span class="n">xsh</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ysh</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Determine which submap we should be drizzling to.</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">submaps</span><span class="p">)</span>
        <span class="n">fits_im</span> <span class="o">=</span> <span class="n">_tmp</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
        <span class="n">wgt</span> <span class="o">=</span> <span class="n">_wgt</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">f_log</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
        
        <span class="c1"># Read in PA of each file to feed into drizzle for rotation</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_c</span><span class="p">,</span><span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">rot</span> <span class="o">=</span> <span class="n">phi</span>

        <span class="c1"># Calculate saturation level for submaps</span>
        <span class="c1"># by weighting each individual satLevel and summing.</span>
        <span class="c1"># Read in each satLevel from individual .max files</span>
        <span class="n">max_indiv</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.max&#39;</span>
        <span class="n">satfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">max_indiv</span><span class="p">)</span>
        <span class="n">satLvl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">satfile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="c1">#changed to simple i/o because the astropy table was breaking for a textfile with a single entry</span>
        <span class="c1">#getsatLvl = Table.read(max_indiv, format=&#39;ascii&#39;, header_start=None)</span>
        <span class="c1">#satLvl = getsatLvl[0][0]</span>
        <span class="n">satLvl_wt</span> <span class="o">=</span> <span class="n">satLvl</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">satLvl_tot</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">+=</span> <span class="n">satLvl_wt</span>
        
        <span class="c1"># Add up the weights that go into each submap</span>
        <span class="n">weightsTot</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">satLvl_sub</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">satLvl_tot</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">/</span> <span class="n">weightsTot</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">fixDAR</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">darRoot</span> <span class="o">=</span> <span class="n">cdwt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;submap: &#39;</span><span class="p">,</span><span class="n">cdwt</span><span class="p">)</span>
            <span class="p">(</span><span class="n">xgeoim</span><span class="p">,</span> <span class="n">ygeoim</span><span class="p">)</span> <span class="o">=</span> <span class="n">dar</span><span class="o">.</span><span class="n">darPlusDistortion</span><span class="p">(</span>
                                   <span class="n">cdwt</span><span class="p">,</span> <span class="n">darRoot</span><span class="p">,</span>
                                   <span class="n">xgeoim</span><span class="o">=</span><span class="n">distXgeoim</span><span class="p">,</span>
                                   <span class="n">ygeoim</span><span class="o">=</span><span class="n">distYgeoim</span><span class="p">,</span>
                                   <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                                   <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>
            <span class="n">xgeoim</span> <span class="o">=</span> <span class="n">xgeoim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
            <span class="n">ygeoim</span> <span class="o">=</span> <span class="n">ygeoim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="s1">&#39;cleanDir$&#39;</span><span class="p">)</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">xgeoim</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">ygeoim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">distXgeoim</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">distYgeoim</span>

        <span class="c1"># Read in MJD of current file from FITS header</span>
        <span class="n">mjd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">])</span>
        <span class="n">mjd_weightedSums</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mjd</span>
        
        <span class="c1"># Drizzle this file ontop of all previous ones.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">_mask</span> <span class="o">=</span> <span class="s1">&#39;cleanDir$masks/mask&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
            <span class="c1">#_mask = cleanDir + &#39;masks/mask&#39; + roots[i] + &#39;.fits&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">in_mask</span> <span class="o">=</span> <span class="n">_mask</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outweig</span> <span class="o">=</span> <span class="n">wgt</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xsh</span> <span class="o">=</span> <span class="n">xsh</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ysh</span> <span class="o">=</span> <span class="n">ysh</span>

        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="p">(</span><span class="n">_cdwt_ir</span><span class="p">,</span> <span class="n">fits_im</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
    
    <span class="c1"># Calculate weighted MJDs for each submap</span>
    <span class="n">mjd_weightedMeans</span> <span class="o">=</span> <span class="n">mjd_weightedSums</span> <span class="o">/</span> <span class="n">weightsTot</span>
    <span class="n">submaps_time_obs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mjd_weightedMeans</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_log</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;satLevel for submaps = &#39;</span><span class="p">,</span> <span class="n">satLvl_sub</span><span class="p">)</span>
    <span class="c1"># Write the saturation level for each submap to a file</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">submaps</span><span class="p">):</span>
        <span class="n">_maxsub</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_max</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">_maxsub</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%15.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">satLvl_sub</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="n">_maxsub</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">submaps</span><span class="p">):</span>
        <span class="n">fits_f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_tmp</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        
        <span class="c1"># Clean up the drizzled image of any largely negative values.</span>
        <span class="c1"># Don&#39;t do this! See how starfinder handles really negative pixels,</span>
        <span class="c1"># and if all goes well...don&#39;t ever correct negative pixels to zero.</span>
        <span class="n">tmp_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sci_mean</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sci_stddev</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Find and fix really bad pixels</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sci_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="n">sci_stddev</span><span class="p">))</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Normalize properly</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">weightsTot</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

        <span class="c1"># Fix the ITIME header keyword so that it matches (weighted).</span>
        <span class="n">itime</span> <span class="o">=</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ITIME&#39;</span><span class="p">)</span>
        <span class="n">itime</span> <span class="o">/=</span> <span class="n">weightsTot</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="c1">#fits_f[0].header.update(&#39;ITIME&#39;, &#39;%.5f&#39; % itime)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ITIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itime</span><span class="p">)</span>

        <span class="c1"># Set the ROTPOSN value for the combined submaps.</span>

        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ITIME&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itime</span><span class="p">)</span>
        
        <span class="c1"># Set the ROTPOSN value for the combined submaps. </span>

        <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.7</span>
            <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ROTPOSN&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">phi</span><span class="p">,</span>
                                  <span class="s1">&#39;rotator user position&#39;</span><span class="p">)</span>

        <span class="c1"># Add keyword with distortion image information</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DISTORTX&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">distXgeoim</span><span class="p">,</span>
                              <span class="s1">&#39;X Distortion Image&#39;</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DISTORTY&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">distYgeoim</span><span class="p">,</span>
                              <span class="s1">&#39;Y Distortion Image&#39;</span><span class="p">)</span>
        
        <span class="c1"># Store weighted MJDs in header</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">,</span> <span class="n">mjd_weightedMeans</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="s1">&#39;Weighted modified julian date of combined observations&#39;</span><span class="p">)</span>
    
        <span class="c1">## Also update date field in header</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DATE&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submaps_time_obs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">),</span> <span class="s1">&#39;Weighted observation date&#39;</span><span class="p">)</span>
        
        <span class="c1"># Write out final submap fits file</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_fits</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>
    
    
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">cdwt</span><span class="p">])</span></div>



<div class="viewcode-block" id="combine_rotation">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_rotation">[docs]</a>
<span class="k">def</span> <span class="nf">combine_rotation</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if images are different PAs. If so, then</span>
<span class="sd">    temporarily rotate the images for xregister to use</span>
<span class="sd">    in order to get image shifts that are fed into drizzle.</span>

<span class="sd">    WARNING: If multiple PAs are found, then everything</span>
<span class="sd">    is rotated to PA = 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diffPA</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">clean_files</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_files</span><span class="p">)):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">clean_files</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">phiRef</span> <span class="o">=</span> <span class="n">phi</span>
            
        <span class="n">diff</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">-</span> <span class="n">phiRef</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Different PAs found&#39;</span><span class="p">)</span>
            <span class="n">diffPA</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_files</span><span class="p">)):</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">clean_files</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
            <span class="n">rot_img</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">phi</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">diffPA</span><span class="p">)</span></div>


<div class="viewcode-block" id="sort_frames">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.sort_frames">[docs]</a>
<span class="k">def</span> <span class="nf">sort_frames</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shiftsTab</span><span class="p">):</span>
    <span class="n">sidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span>

    <span class="c1"># Make sorted lists.</span>
    <span class="n">strehls</span> <span class="o">=</span> <span class="n">strehls</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">fwhm</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sidx</span><span class="p">]</span>
    <span class="n">shiftsX</span> <span class="o">=</span> <span class="n">shiftsTab</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span>
    <span class="n">shiftsX</span> <span class="o">=</span> <span class="n">shiftsX</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">shiftsY</span> <span class="o">=</span> <span class="n">shiftsTab</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span>
    <span class="n">shiftsY</span> <span class="o">=</span> <span class="n">shiftsY</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>

    <span class="c1"># Move all the ones with fwhm = -1 to the end</span>
    <span class="n">gidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fwhm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fwhm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">goodroots</span> <span class="o">=</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gidx</span><span class="p">]</span>
    <span class="n">badroots</span> <span class="o">=</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bidx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found files with incorrect FWHM. They may be rejected.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">badroots</span><span class="p">))</span>

    <span class="n">strehls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">strehls</span><span class="p">[</span><span class="n">gidx</span><span class="p">],</span> <span class="n">strehls</span><span class="p">[</span><span class="n">bidx</span><span class="p">]])</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">fwhm</span><span class="p">[</span><span class="n">gidx</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">[</span><span class="n">bidx</span><span class="p">]])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">gidx</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">bidx</span><span class="p">]])</span>
    <span class="n">shiftsX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">shiftsX</span><span class="p">[</span><span class="n">gidx</span><span class="p">],</span> <span class="n">shiftsX</span><span class="p">[</span><span class="n">bidx</span><span class="p">]])</span>
    <span class="n">shiftsY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">shiftsY</span><span class="p">[</span><span class="n">gidx</span><span class="p">],</span> <span class="n">shiftsY</span><span class="p">[</span><span class="n">bidx</span><span class="p">]])</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="n">goodroots</span> <span class="o">+</span> <span class="n">badroots</span>

    <span class="n">newShiftsTab</span> <span class="o">=</span> <span class="n">shiftsTab</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newShiftsTab</span><span class="p">)):</span>
        <span class="n">newShiftsTab</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span>
        <span class="n">newShiftsTab</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">shiftsX</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span>
        <span class="n">newShiftsTab</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shiftsY</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">newShiftsTab</span><span class="p">)</span></div>



<div class="viewcode-block" id="combine_ref">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_ref">[docs]</a>
<span class="k">def</span> <span class="nf">combine_ref</span><span class="p">(</span><span class="n">coofile</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">refImage_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pulls reference star coordinates from image header keywords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delete any previously existing file</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">coofile</span><span class="p">])</span>

    <span class="n">cFits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">]</span>

    <span class="n">_allCoo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">coofile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># write reference source coordinates</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cFits</span><span class="p">[</span><span class="n">refImage_index</span><span class="p">],</span><span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XREF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   &#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YREF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># write all coordinates, including reference frame</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cFits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XREF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   &#39;</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YREF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">_allCoo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="combine_coo">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_coo">[docs]</a>
<span class="k">def</span> <span class="nf">combine_coo</span><span class="p">(</span><span class="n">coofile</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">refImage_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pulls reference star coordinates from *.coo files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Delete any previously existing file</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">coofile</span><span class="p">])</span>

    <span class="c1"># If images were rotated because of differing PAs, make a</span>
    <span class="c1"># different input list</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cCoos</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;.rcoo&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cCoos</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">]</span>

    <span class="c1"># Need to make table of coordinates of a reference source. These</span>
    <span class="c1"># will be used as initial estimates of the shifts (they don&#39;t necessarily</span>
    <span class="c1"># need to be real sources).</span>
    <span class="n">_allCoo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">coofile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># First line must be the coordinates in the reference image</span>
    <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">cCoos</span><span class="p">[</span><span class="n">refImage_index</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># Now loop through all files (including the reference) and print</span>
    <span class="c1"># coordinates of same reference source.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">cCoos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">_allCoo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="combine_lis">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_lis">[docs]</a>
<span class="k">def</span> <span class="nf">combine_lis</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">):</span>
    <span class="c1"># Delete previously existing file</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">outfile</span><span class="p">])</span>

    <span class="n">cFits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">]</span>

    <span class="c1"># Write all the files to a list</span>
    <span class="n">f_lis</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f_lis</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cFits</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f_lis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># If images were rotated because of differing PAs, make a</span>
    <span class="c1"># different input list for xregister (to get shifts)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">rFits</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;r&#39;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;_r&#39;</span>
        <span class="n">f_lis</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_lis</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rFits</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f_lis</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="combine_register">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_register">[docs]</a>
<span class="k">def</span> <span class="nf">combine_register</span><span class="p">(</span><span class="n">outroot</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">):</span>
    <span class="n">shiftFile</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.shifts&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">shiftFile</span><span class="p">])</span>

    <span class="c1"># xregister parameters</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">immatch</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">unlearn</span><span class="p">(</span><span class="s1">&#39;xregister&#39;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">append</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">databasefmt</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">xwindow</span><span class="o">=</span><span class="s1">&#39;30&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">ywindow</span><span class="o">=</span><span class="s1">&#39;30&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">correlation</span><span class="o">=</span><span class="s1">&#39;fourier&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">function</span><span class="o">=</span><span class="s1">&#39;centroid&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: registering images&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.lis_r&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.lis&#39;</span>

    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>

    <span class="n">regions</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">nx</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">ny</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">ny</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
    <span class="c1">#regions = &#39;[*,*]&#39;</span>
    <span class="c1"># print &#39;input = &#39;, input</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xwindow,ywindow&#39;</span><span class="p">,</span><span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">xwindow</span><span class="p">,</span><span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">ywindow</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;refImage = &#39;</span><span class="p">,</span> <span class="n">refImage</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;regions = &#39;</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shiftFile = &#39;</span><span class="p">,</span> <span class="n">shiftFile</span><span class="p">)</span>

    <span class="n">fileNames</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">)</span> <span class="c1"># removed , header_start=None</span>
    <span class="n">fileNames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fileNames</span><span class="p">)</span>
    <span class="n">fileNames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fileNames</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;S&#39;</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shiftsTable_empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fileNames</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">shiftsTable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">shiftsTable_empty</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;S50&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="c1">#dtype=(float, float, &#39;S50&#39;)</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fileNames</span><span class="p">)):</span>
        <span class="n">inFile</span> <span class="o">=</span> <span class="n">fileNames</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="n">tmpCooFile</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_tmp.coo&#39;</span>
        <span class="n">_coo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpCooFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">_coo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">  </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">_coo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">  </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#Changed from [0][ii+1] to [ii+1][0]</span>
        <span class="n">_coo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">shiftFile</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inFile = &#39;</span><span class="p">,</span> <span class="n">inFile</span><span class="p">)</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">tmpCooFile</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">shiftFile</span><span class="p">)</span>

        <span class="c1"># # Read in the shifts file. Column format is:</span>
        <span class="c1"># # Filename.fits  xshift  yshift</span>
        <span class="n">_shifts</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">shiftFile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">)</span>
        <span class="n">shiftsTable</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shiftsTable</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shiftsTable</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>


    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">shiftFile</span><span class="p">])</span>
    <span class="n">shiftsTable</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shiftFile</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">shiftsTable</span><span class="p">)</span></div>



<div class="viewcode-block" id="combine_log">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_log">[docs]</a>
<span class="k">def</span> <span class="nf">combine_log</span><span class="p">(</span><span class="n">outroot</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">_log</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_log</span><span class="p">])</span>

    <span class="n">f_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="n">f_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%s</span><span class="s1"> </span><span class="si">%6.2f</span><span class="s1"> </span><span class="si">%5.2f</span><span class="s1"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strehls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">f_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="combine_size">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.combine_size">[docs]</a>
<span class="k">def</span> <span class="nf">combine_size</span><span class="p">(</span><span class="n">shiftsTable</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">subroot</span><span class="p">,</span> <span class="n">submaps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the final size of the fully combined image. Use the</span>
<span class="sd">    shifts stored in the shiftsTable.</span>

<span class="sd">    @param shiftsTable: Table with x and y shifts for each image</span>
<span class="sd">    @type shiftsTable: ascii table</span>
<span class="sd">    @param refImage: The reference image from which the shifts are</span>
<span class="sd">        calculated from.</span>
<span class="sd">    @type refImage: string</span>
<span class="sd">    @param outroot: The name of the file for which shift information</span>
<span class="sd">        will be stored. The filename will be &lt;outroot&gt;.coo.</span>
<span class="sd">    @type outroot: string</span>
<span class="sd">    @param subroot: Same as outroot but for submaps</span>
<span class="sd">    @type subroot: string</span>
<span class="sd">    @param submaps: number of submaps</span>
<span class="sd">    @type sbumaps: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_allShifts</span> <span class="o">=</span> <span class="n">shiftsTable</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span>
    <span class="n">y_allShifts</span> <span class="o">=</span> <span class="n">shiftsTable</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span>


    <span class="n">xhi</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_allShifts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">xlo</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_allShifts</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">yhi</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_allShifts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ylo</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_allShifts</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="c1"># Make sure to include the edges of all images.</span>
    <span class="c1"># Might require some extra padding on one side.</span>
    <span class="n">maxoffset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span><span class="p">])</span>

    <span class="n">orig_img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
    <span class="n">orig_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">padd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">orig_size</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">))</span>

    <span class="c1"># Read in the reference star&#39;s position in the ref image and translate</span>
    <span class="c1"># it into the coordinates of the final main and sub maps.</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">refImage</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xrefSrc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XREF&#39;</span><span class="p">])</span>
    <span class="n">yrefSrc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YREF&#39;</span><span class="p">])</span>

    <span class="n">xrefSrc</span> <span class="o">=</span> <span class="n">xrefSrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>
    <span class="n">yrefSrc</span> <span class="o">=</span> <span class="n">yrefSrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>

    <span class="n">cooMain</span> <span class="o">=</span> <span class="p">[</span><span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">]</span>
    <span class="n">cooSubs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.coo&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subroot</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">submaps</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">cooAll</span> <span class="o">=</span> <span class="n">cooMain</span> <span class="o">+</span> <span class="n">cooSubs</span>

    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">(</span><span class="n">cooAll</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">coo</span> <span class="ow">in</span> <span class="n">cooAll</span><span class="p">:</span>
        <span class="n">_allCoo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">coo</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.3f</span><span class="s1"> </span><span class="si">%9.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xrefSrc</span><span class="p">,</span> <span class="n">yrefSrc</span><span class="p">))</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">xysize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">orig_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: Size of output image is </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xysize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xysize</span></div>


<div class="viewcode-block" id="setup_drizzle">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.setup_drizzle">[docs]</a>
<span class="k">def</span> <span class="nf">setup_drizzle</span><span class="p">(</span><span class="n">imgsize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup drizzle parameters for NIRC2 data.</span>
<span class="sd">    @param imgsize: The size (in pixels) of the final drizzle image.</span>
<span class="sd">    This assumes that the image will be square.</span>
<span class="sd">    @type imgsize: int</span>
<span class="sd">    @param mask: The name of the mask to use during</span>
<span class="sd">    drizzle.</span>
<span class="sd">    @param type: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup the drizzle parameters we will use</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stsdas&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;analysis&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;dither&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">unlearn</span><span class="p">(</span><span class="s1">&#39;drizzle&#39;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outweig</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">in_mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">wt_scl</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outnx</span> <span class="o">=</span> <span class="n">imgsize</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">outny</span> <span class="o">=</span> <span class="n">imgsize</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">pixfrac</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="s1">&#39;lanczos3&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">shft_un</span> <span class="o">=</span> <span class="s1">&#39;input&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">shft_fr</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">expkey</span> <span class="o">=</span> <span class="s1">&#39;ITIME&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">in_un</span> <span class="o">=</span> <span class="s1">&#39;counts&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">out_un</span> <span class="o">=</span> <span class="s1">&#39;counts&#39;</span></div>


<div class="viewcode-block" id="clean_drizzle">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_drizzle">[docs]</a>
<span class="k">def</span> <span class="nf">clean_drizzle</span><span class="p">(</span><span class="n">xgeoim</span><span class="p">,</span> <span class="n">ygeoim</span><span class="p">,</span> <span class="n">_bp</span><span class="p">,</span> <span class="n">_cd</span><span class="p">,</span> <span class="n">_wgt</span><span class="p">,</span> <span class="n">_dlog</span><span class="p">,</span>
        <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span>
        <span class="n">use_koa_weather</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Get the distortion maps for this instrument.</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_bp</span><span class="p">)</span>
    <span class="n">distXgeoim</span><span class="p">,</span> <span class="n">distYgeoim</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_distortion_maps</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fixDAR</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">darRoot</span> <span class="o">=</span> <span class="n">_cd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">xgeoim</span><span class="p">,</span> <span class="n">ygeoim</span><span class="p">)</span> <span class="o">=</span> <span class="n">dar</span><span class="o">.</span><span class="n">darPlusDistortion</span><span class="p">(</span>
                               <span class="n">_bp</span><span class="p">,</span> <span class="n">darRoot</span><span class="p">,</span> <span class="n">xgeoim</span><span class="p">,</span> <span class="n">ygeoim</span><span class="p">,</span>
                               <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                               <span class="n">use_koa_weather</span><span class="o">=</span><span class="n">use_koa_weather</span><span class="p">)</span>

        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">xgeoim</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">ygeoim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">xgeoim</span> <span class="o">=</span> <span class="n">distXgeoim</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="o">.</span><span class="n">ygeoim</span> <span class="o">=</span> <span class="n">distYgeoim</span>

    <span class="n">ir</span><span class="o">.</span><span class="n">drizzle</span><span class="p">(</span><span class="n">_bp</span><span class="p">,</span> <span class="n">_cd</span><span class="p">,</span> <span class="n">outweig</span><span class="o">=</span><span class="n">_wgt</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="n">_dlog</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_cosmicrays">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_cosmicrays">[docs]</a>
<span class="k">def</span> <span class="nf">clean_cosmicrays</span><span class="p">(</span><span class="n">_ff</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">wave</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the image of cosmicrays and make a mask containing the location</span>
<span class="sd">    of all the cosmicrays. The CR masks can later be used in combine() to</span>
<span class="sd">    keep cosmicrays from being included.</span>

<span class="sd">    @param _ff: Flat fielded file on which to fix cosmic rays. A new</span>
<span class="sd">        image will be created with the _f appended to it.</span>
<span class="sd">    @type _ff: string</span>
<span class="sd">    @param _mask: The filename used for the resulting mask.</span>
<span class="sd">    @type _mask: string</span>
<span class="sd">    @parram wave: The filter of the observations (e.g. &#39;kp&#39;, &#39;lp&#39;). This</span>
<span class="sd">        is used to determine different thresholds for CR rejection.</span>
<span class="sd">    @type wave: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the threshold at which we should start looking</span>
    <span class="c1"># for cosmicrays. Need to figure out the mean level of the</span>
    <span class="c1"># background.</span>
    <span class="n">ff_img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_ff</span><span class="p">)</span>
    <span class="n">tmp_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">ff_img</span><span class="p">,</span>
                                          <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                          <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stddev</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># CR candidates are those that exceed surrounding pixels by</span>
    <span class="c1"># this threshold amount.</span>
    <span class="n">crthreshold</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">stddev</span>

    <span class="n">fluxray</span> <span class="o">=</span> <span class="mf">13.</span>
    <span class="k">if</span> <span class="s1">&#39;h&#39;</span> <span class="ow">in</span> <span class="n">wave</span><span class="p">:</span>
        <span class="n">fluxray</span> <span class="o">=</span> <span class="mf">10.</span>
    <span class="k">if</span> <span class="s1">&#39;kp&#39;</span> <span class="ow">in</span> <span class="n">wave</span><span class="p">:</span>
        <span class="n">fluxray</span> <span class="o">=</span> <span class="mf">13.</span>
    <span class="k">if</span> <span class="s1">&#39;lp&#39;</span> <span class="ow">in</span> <span class="n">wave</span><span class="p">:</span>
        <span class="n">fluxray</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="k">if</span> <span class="s1">&#39;ms&#39;</span> <span class="ow">in</span> <span class="n">wave</span><span class="p">:</span>
        <span class="n">fluxray</span> <span class="o">=</span> <span class="mf">10.0</span>

    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;noao&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;imred&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;crutil&#39;</span><span class="p">,</span> <span class="n">doprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hush</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">unlearn</span><span class="p">(</span><span class="s1">&#39;cosmicrays&#39;</span><span class="p">)</span>

    <span class="n">ir</span><span class="o">.</span><span class="n">cosmicrays</span><span class="p">(</span><span class="n">_ff</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">crmasks</span><span class="o">=</span><span class="n">_mask</span><span class="p">,</span> <span class="n">thresho</span><span class="o">=</span><span class="n">crthreshold</span><span class="p">,</span>
                  <span class="n">fluxrat</span><span class="o">=</span><span class="n">fluxray</span><span class="p">,</span> <span class="n">npasses</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                  <span class="n">interac</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="s1">&#39;NO&#39;</span><span class="p">)</span>

    <span class="n">ir</span><span class="o">.</span><span class="n">imcopy</span><span class="p">(</span><span class="n">_mask</span><span class="o">+</span><span class="s1">&#39;.pl&#39;</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_mask</span> <span class="o">+</span> <span class="s1">&#39;.pl&#39;</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_mask</span> <span class="o">+</span> <span class="s1">&#39;.pl&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_cosmicrays2">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_cosmicrays2">[docs]</a>
<span class="k">def</span> <span class="nf">clean_cosmicrays2</span><span class="p">(</span><span class="n">_ff</span><span class="p">,</span> <span class="n">_ff_cr</span><span class="p">,</span> <span class="n">_mask</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span>
                      <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the image of cosmicrays and make a mask containing the location</span>
<span class="sd">    of all the cosmicrays. The CR masks can later be used in combine() to</span>
<span class="sd">    keep cosmicrays from being included.</span>

<span class="sd">    @param _ff: Flat fielded file on which to fix cosmic rays. A new</span>
<span class="sd">        image will be created with the _f appended to it.</span>
<span class="sd">    @type _ff: string</span>
<span class="sd">    @param _ff_cr: Output image with cosmicrays fixed.</span>
<span class="sd">    @type _ff_cr: string</span>
<span class="sd">    @param _mask: The filename used for the resulting mask.</span>
<span class="sd">    @type _mask: string</span>
<span class="sd">    @parram wave: The filter of the observations (e.g. &#39;kp&#39;, &#39;lp&#39;). This</span>
<span class="sd">        is used to determine different thresholds for CR rejection.</span>
<span class="sd">    @type wave: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the threshold at which we should start looking</span>
    <span class="c1"># for cosmicrays. Need to figure out the mean level of the</span>
    <span class="c1"># background.</span>
    <span class="n">ff_img</span><span class="p">,</span> <span class="n">ff_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_ff</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">stddev</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">ff_img</span><span class="p">,</span>
                                                     <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                     <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Get the instrument gain</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_gain</span><span class="p">()</span>

    <span class="n">sampmode</span> <span class="o">=</span> <span class="n">ff_hdr</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;sampmode&#39;</span><span class="p">]]</span>
    <span class="n">numreads</span> <span class="o">=</span> <span class="n">ff_hdr</span><span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">hdr_keys</span><span class="p">[</span><span class="s1">&#39;nfowler&#39;</span><span class="p">]]</span>
    
    <span class="k">if</span> <span class="n">sampmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">readnoise</span> <span class="o">=</span> <span class="mf">15.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">16.0</span> <span class="o">/</span> <span class="n">numreads</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="kn">from</span> <span class="nn">jlu.util</span> <span class="kn">import</span> <span class="n">cosmics</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cosmics</span><span class="o">.</span><span class="n">cosmicsimage</span><span class="p">(</span><span class="n">ff_img</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">,</span> <span class="n">readnoise</span><span class="o">=</span><span class="n">readnoise</span><span class="p">,</span>
                             <span class="n">sigclip</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigfrac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">objlim</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_ff_cr</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">cleanarray</span><span class="p">,</span> <span class="n">ff_hdr</span><span class="p">,</span>
                   <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mask</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ff_hdr</span><span class="p">,</span>
                   <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="clean_persistance">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_persistance">[docs]</a>
<span class="k">def</span> <span class="nf">clean_persistance</span><span class="p">(</span><span class="n">_n</span><span class="p">,</span> <span class="n">_pers</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make masks of the persistance to be used in combining the images</span>
<span class="sd">    later on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read in image</span>
    <span class="n">fits_f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_n</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Define the high pixels</span>
    <span class="n">persPixels</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_saturation_level</span><span class="p">())</span>

    <span class="c1"># Set saturated pixels to 0, good pixels to 1</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">persPixels</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="c1"># Save to an image</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_pers</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_bkgsubtract">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_bkgsubtract">[docs]</a>
<span class="k">def</span> <span class="nf">clean_bkgsubtract</span><span class="p">(</span><span class="n">_ff_f</span><span class="p">,</span> <span class="n">_bp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do additional background subtraction of any excess background</span>
<span class="sd">    flux. This isn&#39;t strictly necessary since it just removes a constant.&quot;&quot;&quot;</span>
    <span class="c1"># Open the image for processing.</span>
    <span class="n">fits_f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_ff_f</span><span class="p">)</span>

    <span class="c1"># Calculate mean and STD for science image</span>
    <span class="n">tmp_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sci_mean</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sci_stddev</span> <span class="o">=</span> <span class="n">tmp_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Excess background flux at (mean - 2*std)</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">sci_mean</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sci_stddev</span><span class="p">)</span>
    <span class="c1">#print &#39;Bkg mean = %5d +/- %5d   bkg = %5d  Name = %s&#39; % \</span>
    <span class="c1">#      (sci_mean, sci_stddev, bkg, _ff_f)</span>

    <span class="c1"># Open old, subtract BKG</span>

    <span class="c1"># Find really bad pixels</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sci_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="n">sci_stddev</span><span class="p">))</span>

    <span class="c1"># Subtract background</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">bkg</span>

    <span class="c1"># Fix really bad negative pixels.</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Write to new file</span>
    <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_bp</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>

    <span class="c1"># Return the background we subtracted off</span>
    <span class="k">return</span> <span class="n">bkg</span></div>


<div class="viewcode-block" id="clean_makecoo">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.clean_makecoo">[docs]</a>
<span class="k">def</span> <span class="nf">clean_makecoo</span><span class="p">(</span><span class="n">_ce</span><span class="p">,</span> <span class="n">_cc</span><span class="p">,</span> <span class="n">refSrc</span><span class="p">,</span> <span class="n">strSrc</span><span class="p">,</span> <span class="n">aotsxyRef</span><span class="p">,</span> <span class="n">radecRef</span><span class="p">,</span>
        <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">,</span> <span class="n">check_loc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">update_fits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cent_box</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">offset_method</span><span class="o">=</span><span class="s1">&#39;aotsxy&#39;</span><span class="p">,</span><span class="n">pcuxyRef</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the *.coo file for this science image. Use the difference</span>
<span class="sd">    between the AOTSX/Y keywords from a reference image and each science</span>
<span class="sd">    image to tell how the positions of the two frames are related.</span>

<span class="sd">    @param _ce: Name of the input cleaned file.</span>
<span class="sd">    @type _ce: string</span>
<span class="sd">    @param _cc: Name of the output header modified image.</span>
<span class="sd">    @type _cc: string</span>
<span class="sd">    @param refSrc: Array with the X/Y positions of the reference source.</span>
<span class="sd">        This will be put into the image header and the *.coo file.</span>
<span class="sd">    @type refSrc: array of floats with length=2 [x, y]</span>
<span class="sd">    @param strSrc: Array with the X/Y positions of the strehl source.</span>
<span class="sd">        This will be put into the image header.</span>
<span class="sd">    @type strSrc: array of floats with length=2 [x, y]</span>
<span class="sd">    @param aotsxyRef: The AOTSX/Y header values from the reference image.</span>
<span class="sd">    @type aotsxyRef: array of floats with length=2 [x, y]</span>
<span class="sd">    @param radecRef: The RA/DEC header values from the reference image.</span>
<span class="sd">    @type radecRef: array of floats with length=2 [x, y]</span>

<span class="sd">    check_loc : bool, default=True</span>
<span class="sd">        If True the reference source is recentered for this frame.</span>
<span class="sd">        Use False if the offsets are large enough to move the reference source</span>
<span class="sd">        off of the image.</span>
<span class="sd">    update_fits : bool, default=True</span>
<span class="sd">        Update the fits files with the reference pixel values</span>
<span class="sd">    cent_box : float, default: 12</span>
<span class="sd">        Box size to center the source</span>
<span class="sd">    offset_method : str, default=&#39;aotsxy&#39;</span>
<span class="sd">        Method to calculate offsets from reference image.</span>
<span class="sd">        Options are &#39;aotsxy&#39; or &#39;radec&#39;.</span>
<span class="sd">        In images where &#39;aotsxy&#39; keywords aren&#39;t reliable, &#39;radec&#39; calculated</span>
<span class="sd">        offsets may work better.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_ce</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">radec</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">])]</span>
    <span class="n">aotsxy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">getAotsxy</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">offset_method</span> <span class="o">==</span> <span class="s1">&#39;pcu&#39;</span><span class="p">:</span>
        <span class="n">pcuxy</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PCSFX&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PCSFY&#39;</span><span class="p">])]</span>  <span class="c1">#New version may be PCUX and PCUY</span>
        <span class="n">pcu_scale</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_pcu_scale</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="c1"># Determine the image&#39;s PA and plate scale</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_plate_scale</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="c1"># Determine the instrument angle w.r.t. the AO bench.</span>
    <span class="n">inst_angle</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_instrument_angle</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

    <span class="c1"># Calculate the pixel offsets from the reference image</span>
    <span class="k">if</span> <span class="n">offset_method</span> <span class="o">==</span> <span class="s1">&#39;radec&#39;</span><span class="p">:</span>
        <span class="n">d_xy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">radec2pix</span><span class="p">(</span><span class="n">radec</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">radecRef</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">offset_method</span> <span class="o">==</span> <span class="s1">&#39;aotsxy&#39;</span><span class="p">:</span>
        <span class="n">d_xy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">aotsxy2pix</span><span class="p">(</span><span class="n">aotsxy</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">aotsxyRef</span><span class="p">,</span>
                                   <span class="n">inst_angle</span><span class="o">=</span><span class="n">inst_angle</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">offset_method</span> <span class="o">==</span> <span class="s1">&#39;pcu&#39;</span><span class="p">:</span>
            <span class="n">d_xy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">pcuxy2pix</span><span class="p">(</span><span class="n">pcuxy</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">pcu_scale</span><span class="p">,</span> <span class="n">pcuxyRef</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_xy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">aotsxy2pix</span><span class="p">(</span><span class="n">aotsxy</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">aotsxyRef</span><span class="p">,</span>
                                   <span class="n">inst_angle</span><span class="o">=</span><span class="n">inst_angle</span><span class="p">)</span>

    <span class="c1"># In the new image, find the REF and STRL coords</span>
    <span class="n">xref</span> <span class="o">=</span> <span class="n">refSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">d_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yref</span> <span class="o">=</span> <span class="n">refSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xstr</span> <span class="o">=</span> <span class="n">strSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">d_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ystr</span> <span class="o">=</span> <span class="n">strSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clean_makecoo: xref, yref start = </span><span class="si">{0:.2f}</span><span class="s1"> </span><span class="si">{1:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">))</span>

    <span class="c1"># re-center stars to get exact coordinates</span>
    <span class="k">if</span> <span class="n">check_loc</span><span class="p">:</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">imcntr</span><span class="p">(</span><span class="n">_ce</span><span class="p">,</span> <span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">,</span> <span class="n">cbox</span><span class="o">=</span><span class="n">cent_box</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">xref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">yref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">imcntr</span><span class="p">(</span><span class="n">_ce</span><span class="p">,</span> <span class="n">xstr</span><span class="p">,</span> <span class="n">ystr</span><span class="p">,</span> <span class="n">cbox</span><span class="o">=</span><span class="n">cent_box</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">xstr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ystr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clean_makecoo: xref, yref final = </span><span class="si">{0:.2f}</span><span class="s1"> </span><span class="si">{1:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">))</span>

    <span class="c1"># write reference star x,y to fits header</span>
    <span class="k">if</span> <span class="n">update_fits</span><span class="p">:</span>
        <span class="n">fits_f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_ce</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;XREF&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">xref</span><span class="p">,</span>
                             <span class="s1">&#39;Cross Corr Reference Src x&#39;</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;YREF&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">yref</span><span class="p">,</span>
                             <span class="s1">&#39;Cross Corr Reference Src y&#39;</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;XSTREHL&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">xstr</span><span class="p">,</span>
                             <span class="s1">&#39;Strehl Reference Src x&#39;</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;YSTREHL&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ystr</span><span class="p">,</span>
                             <span class="s1">&#39;Strehl Reference Src y&#39;</span><span class="p">)</span>
        <span class="n">fits_f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">_cc</span><span class="p">,</span> <span class="n">output_verify</span><span class="o">=</span><span class="n">outputVerify</span><span class="p">)</span>

    <span class="n">file</span><span class="p">(</span><span class="n">_cc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.coo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7.2f</span><span class="s1">  </span><span class="si">%7.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">))</span>

    <span class="c1"># Make a temporary rotated coo file, in case there are any data sets</span>
    <span class="c1"># with various PAs; needed for xregister; remove later</span>
    <span class="n">xyRef_rot</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">rotate_coo</span><span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">yref</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
    <span class="n">xref_r</span> <span class="o">=</span> <span class="n">xyRef_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yref_r</span> <span class="o">=</span> <span class="n">xyRef_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">xyStr_rot</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">rotate_coo</span><span class="p">(</span><span class="n">xstr</span><span class="p">,</span> <span class="n">ystr</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
    <span class="n">xstr_r</span> <span class="o">=</span> <span class="n">xyStr_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ystr_r</span> <span class="o">=</span> <span class="n">xyStr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">file</span><span class="p">(</span><span class="n">_cc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;.rcoo&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7.2f</span><span class="s1">  </span><span class="si">%7.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xref_r</span><span class="p">,</span> <span class="n">yref_r</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="mosaic_ref">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.mosaic_ref">[docs]</a>
<span class="k">def</span> <span class="nf">mosaic_ref</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate an initial guess at the offsets between mosaic frames.</span>
<span class="sd">    using the AOTSX/Y keywords from a reference image and each science</span>
<span class="sd">    image to tell how the positions of the two frames are related.</span>

<span class="sd">    @param cleanDir: Name of the input cleaned file.</span>
<span class="sd">    @type cleanDir: string</span>
<span class="sd">    @param roots: List of root filenames</span>
<span class="sd">    @type roots: list of strings</span>
<span class="sd">    @param diffPA: 1 = found different PAs so use rot images.</span>
<span class="sd">    @type difPA: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Setup clean file lists.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">fileNames</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fileNames</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">rootDir</span><span class="o">=</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
        
    <span class="n">hdrRef</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aotsxyRef</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">getAotsxy</span><span class="p">(</span><span class="n">hdrRef</span><span class="p">)</span>

    <span class="c1"># Determine the image&#39;s PA and plate scale</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_position_angle</span><span class="p">(</span><span class="n">hdrRef</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_plate_scale</span><span class="p">(</span><span class="n">hdrRef</span><span class="p">)</span>
    <span class="n">inst_angle</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">get_instrument_angle</span><span class="p">(</span><span class="n">hdrRef</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inst_angle = &#39;</span><span class="p">,</span> <span class="n">inst_angle</span><span class="p">)</span>

    <span class="n">_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># First line of shifts file must be for a reference</span>
    <span class="c1"># image (assumed to be the first image).</span>
    <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7.2f</span><span class="s1">  </span><span class="si">%7.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="n">rr</span><span class="p">],</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aotsxy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">getAotsxy</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>

        <span class="c1"># Calculate the pixel offsets from the reference image</span>
        <span class="c1"># We&#39;ve been using aotsxy2pix, but the keywords are wrong</span>
        <span class="c1"># for 07maylgs and 07junlgs</span>
        <span class="n">d_xy</span> <span class="o">=</span> <span class="n">kai_util</span><span class="o">.</span><span class="n">aotsxy2pix</span><span class="p">(</span><span class="n">aotsxy</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">aotsxyRef</span><span class="p">,</span> <span class="n">inst_angle</span><span class="o">=</span><span class="n">inst_angle</span><span class="p">)</span>

        <span class="n">_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7.2f</span><span class="s1">  </span><span class="si">%7.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="Sky">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky">[docs]</a>
<span class="k">class</span> <span class="nc">Sky</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sciDir</span><span class="p">,</span> <span class="n">skyDir</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">skyfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">angleOffset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
        <span class="c1"># Setup some variables we will need later on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sciDir</span> <span class="o">=</span> <span class="n">sciDir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyDir</span> <span class="o">=</span> <span class="n">skyDir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">wave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyFile</span> <span class="o">=</span> <span class="n">skyfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angleOffset</span> <span class="o">=</span> <span class="n">angleOffset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaultSky</span> <span class="o">=</span> <span class="n">skyDir</span> <span class="o">+</span> <span class="s1">&#39;sky_&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;lp&#39;</span> <span class="ow">or</span> <span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__initLp__</span><span class="p">()</span>

        <span class="c1"># This will be the final returned skyname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyName</span> <span class="o">=</span> <span class="n">skyDir</span> <span class="o">+</span> <span class="s1">&#39;sky_scaled.fits&#39;</span>

<div class="viewcode-block" id="Sky.__initLp__">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.__initLp__">[docs]</a>
    <span class="k">def</span> <span class="nf">__initLp__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing Lp Sky skyfile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyFile</span><span class="p">))</span>

        <span class="c1"># Read skies from manual sky file (format: raw_science   sky)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyFile</span><span class="p">):</span>
            <span class="n">skyTab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyFile</span><span class="p">,</span>
                                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">skyTab</span><span class="p">[</span><span class="n">skyTab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">skies</span> <span class="o">=</span> <span class="n">skyTab</span><span class="p">[</span><span class="n">skyTab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">skyAng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">skies</span><span class="p">)],</span> <span class="n">Float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">skies</span><span class="p">)):</span>
                <span class="n">sky</span> <span class="o">=</span> <span class="n">skies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyDir</span> <span class="o">+</span> <span class="n">sky</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">skyAng</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ROTPPOSN&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Read in the sky table. Determine the effective K-mirror</span>
            <span class="c1"># angle for each sky.</span>
            <span class="n">skyTab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyDir</span> <span class="o">+</span> <span class="s1">&#39;rotpposn.txt&#39;</span><span class="p">,</span>
                                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">skies</span> <span class="o">=</span> <span class="n">skyTab</span><span class="p">[</span><span class="n">skyTab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">skyAng</span> <span class="o">=</span> <span class="n">skyTab</span><span class="p">[</span><span class="n">skyTab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># The optimal sky angle to use is skyAng = A + B*sciAng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angFitA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angleOffset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angFitB</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Open a log file that we will keep</span>
        <span class="n">_skylog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sciDir</span> <span class="o">+</span> <span class="s1">&#39;sci_sky_subtract.log&#39;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_skylog</span><span class="p">])</span>
        <span class="n">f_skylog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_skylog</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># Stuff we are keeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyTab</span> <span class="o">=</span> <span class="n">skyTab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skies</span> <span class="o">=</span> <span class="n">skies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyAng</span> <span class="o">=</span> <span class="n">skyAng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_skylog</span> <span class="o">=</span> <span class="n">f_skylog</span></div>


<div class="viewcode-block" id="Sky.getSky">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.getSky">[docs]</a>
    <span class="k">def</span> <span class="nf">getSky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_n</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;lp&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSkyLp</span><span class="p">(</span><span class="n">_n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultSky</span>

        <span class="c1"># Edit the science image to contain the</span>
        <span class="c1"># original sky name that will be subtracted.</span>
        <span class="n">skyOrigName</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="n">sky</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ir</span><span class="o">.</span><span class="n">hedit</span><span class="p">(</span><span class="n">_n</span><span class="p">,</span> <span class="s1">&#39;SKYSUB&#39;</span><span class="p">,</span> <span class="n">skyOrigName</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>

        <span class="c1"># Now scale the sky to the science image</span>
        <span class="n">skyScale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleSky</span><span class="p">(</span><span class="n">_n</span><span class="p">,</span> <span class="n">sky</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">skyScale</span></div>


<div class="viewcode-block" id="Sky.scaleSky">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.scaleSky">[docs]</a>
    <span class="k">def</span> <span class="nf">scaleSky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_n</span><span class="p">,</span> <span class="n">_sky</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scale the mean level of the sky so that it matches the</span>
<span class="sd">        science image.</span>

<span class="sd">        @param _n: name of science frame</span>
<span class="sd">        @type _n: string</span>
<span class="sd">        @param _sky: name of sky frame</span>
<span class="sd">        @type _sky: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">skyName</span><span class="p">])</span>

        <span class="c1"># scale sky to science frame</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="n">n_img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_n</span><span class="p">)</span>
            <span class="n">sci_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">n_img</span><span class="p">,</span>
                                                  <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                  <span class="n">iters</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">sci_mean</span> <span class="o">=</span> <span class="n">sci_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">sky_img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_sky</span><span class="p">)</span>
            <span class="n">sky_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">sky_img</span><span class="p">,</span>
                                                  <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                                  <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">sky_mean</span> <span class="o">=</span> <span class="n">sky_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            
            <span class="n">fact</span> <span class="o">=</span> <span class="n">sci_mean</span><span class="o">/</span><span class="n">sky_mean</span>
            <span class="c1">#print &#39;scaleSky: factor = %5f  sci_mean = %5f  sky_mean = %5f&#39; % \</span>
            <span class="c1">#      (fact, sci_mean, sky_mean)</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">imarith</span><span class="p">(</span><span class="n">_sky</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">fact</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ir</span><span class="o">.</span><span class="n">imcopy</span><span class="p">(</span><span class="n">_sky</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyName</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyName</span></div>



<div class="viewcode-block" id="Sky.getSkyLp">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.getSkyLp">[docs]</a>
    <span class="k">def</span> <span class="nf">getSkyLp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine which sky we should use for L&#39;. Does all the</span>
<span class="sd">        rotator mirror angle matching.</span>

<span class="sd">        @param _n: Name of science frame.</span>
<span class="sd">        @type _n: string</span>
<span class="sd">        @returns sky: name of sky file to use.</span>
<span class="sd">        @rtype sky: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sky subtract</span>
        <span class="c1"># determine the best angle for sky or use manual file</span>

        <span class="c1"># -- Determine the rotpposn for this image</span>
        <span class="n">sciAng_tmp</span> <span class="o">=</span> <span class="n">ir</span><span class="o">.</span><span class="n">hselect</span><span class="p">(</span><span class="n">_n</span><span class="p">,</span> <span class="s2">&quot;ROTPPOSN&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">Stdout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sciAng</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sciAng_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># -- Determine the best sky rotpposn.</span>
        <span class="n">skyBest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angFitA</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angFitB</span> <span class="o">*</span> <span class="n">sciAng</span><span class="p">)</span>

        <span class="c1"># -- Repair all angles to be between -180 and 180.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skyBest</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">):</span> <span class="n">skyBest</span> <span class="o">-=</span> <span class="mf">360.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skyBest</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">):</span> <span class="n">skyBest</span> <span class="o">+=</span> <span class="mf">360.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sciAng</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">):</span> <span class="n">sciAng</span> <span class="o">-=</span> <span class="mf">360.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sciAng</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">):</span> <span class="n">sciAng</span> <span class="o">+=</span> <span class="mf">360.0</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyFile</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">_n</span><span class="p">):</span>
                    <span class="n">skyidx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># -- Determine which sky file to use</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">skyAngle</span> <span class="o">-</span> <span class="n">skyBest</span><span class="p">)</span> <span class="k">for</span> <span class="n">skyAngle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyAng</span><span class="p">]</span>
            <span class="n">skyidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

        <span class="n">sky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">skies</span><span class="p">[</span><span class="n">skyidx</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Science = &#39;</span><span class="p">,</span> <span class="n">_n</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Sky image = &#39;</span><span class="p">,</span> <span class="n">sky</span><span class="p">))</span>

        <span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">  </span><span class="si">%6.1f</span><span class="s1">  </span><span class="si">%6.1f</span><span class="s1">&#39;</span> <span class="o">%</span> \
              <span class="p">(</span><span class="n">_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skies</span><span class="p">[</span><span class="n">skyidx</span><span class="p">],</span> <span class="n">sciAng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyAng</span><span class="p">[</span><span class="n">skyidx</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_skylog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">foo</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">sky</span></div>


<div class="viewcode-block" id="Sky.getNonlinearCorrection">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.getNonlinearCorrection">[docs]</a>
    <span class="k">def</span> <span class="nf">getNonlinearCorrection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sky</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the non-linearity level. Raw data level of</span>
<span class="sd">        non-linearity is 12,000 but we subtracted</span>
<span class="sd">        off a sky which changed this level. The sky is</span>
<span class="sd">        scaled, so the level will be slightly different</span>
<span class="sd">        for every frame.</span>

<span class="sd">        @param sky: File name of the sky used.</span>
<span class="sd">        @type sky: string</span>
<span class="sd">        @returns (sky_mean + sky_stddev) which is the value that should</span>
<span class="sd">            be subtracted off of the saturation count level.</span>
<span class="sd">        @rtype float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read in the FITS file</span>
        <span class="n">sky_img</span><span class="p">,</span> <span class="n">sky_hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get the sigma-clipped mean and stddev</span>
        <span class="n">sky_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">sky_img</span><span class="p">,</span>
                                              <span class="n">sigma_upper</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sigma_lower</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                              <span class="n">iters</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">sky_mean</span> <span class="o">=</span> <span class="n">sky_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sky_stddev</span> <span class="o">=</span> <span class="n">sky_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># -- Log what we did</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;lp&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%7d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sky_mean</span><span class="p">,</span> <span class="n">sky_stddev</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">f_skylog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">foo</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">sky_mean</span> <span class="o">+</span> <span class="n">sky_stddev</span></div>


<div class="viewcode-block" id="Sky.close">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.Sky.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close log files opened at init.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;lp&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_skylog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="mosaic">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.mosaic">[docs]</a>
<span class="k">def</span> <span class="nf">mosaic</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outSuffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">trim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fwhm_max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">submaps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fixDAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maskSubmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instruments</span><span class="o">.</span><span class="n">default_inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Accepts a list of cleaned images and does a weighted combining after</span>
<span class="sd">    performing frame selection based on the Strehl and FWHM.</span>

<span class="sd">    Each image must have an associated *.coo file which gives the rough</span>
<span class="sd">    position of the reference source.</span>

<span class="sd">    @param files: List of integer file numbers to include in combine.</span>
<span class="sd">    @type files: list of int</span>
<span class="sd">    @param wave: Filter of observations (e.g. &#39;kp&#39;, &#39;lp&#39;, &#39;h&#39;)</span>
<span class="sd">    @type wave: string</span>
<span class="sd">    @param outroot: The output root name (e.g. &#39;06jullgs&#39;). The final combined</span>
<span class="sd">        file names will be &lt;outroot&gt;_&lt;field&gt;_&lt;wave&gt;. The &lt;field&gt; keyword</span>
<span class="sd">        is optional.</span>

<span class="sd">        Examples:</span>
<span class="sd">        06jullgs_kp for outroot=&#39;06jullgs&#39; and wave=&#39;kp&#39;</span>
<span class="sd">        06jullgs_arch_f1_kp for adding field=&#39;arch_f1&#39;</span>
<span class="sd">    @type outroot: string</span>
<span class="sd">    @kwparam field: Optional field name used to get to clean directory and</span>
<span class="sd">        also effects the final output file name.</span>
<span class="sd">    @type field: string</span>
<span class="sd">    @kwparam trim: Optional file trimming based on image quality. Default</span>
<span class="sd">        is 0. Set to 1 to turn trimming on.</span>
<span class="sd">    @kwparam outSuffix: Optional suffix used to modify final output file name.</span>
<span class="sd">    @type outSuffix: string</span>
<span class="sd">    @type trim: 0 or 1</span>
<span class="sd">    @kwparam weight: Optional weighting based on Strehl. Set to 1 to</span>
<span class="sd">        to turn file weighting on (default is 0).</span>
<span class="sd">    @type weight: 0 or 1</span>
<span class="sd">    @kwparam fwhm_max: The maximum allowed FWHM for keeping frames when</span>
<span class="sd">        trimming is turned on.</span>
<span class="sd">    @type fwhm_max: int</span>
<span class="sd">    @kwparam submaps: Set to the number of submaps to be made (def=0).</span>
<span class="sd">    @type submaps: int</span>
<span class="sd">    @kwparam mask: Set to false for maser mosaics; 06maylgs1 is an exception</span>
<span class="sd">    @type mask: Boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start out in something like &#39;06maylgs1/reduce/kp/&#39;</span>
    <span class="c1"># Setup some files and directories</span>
    <span class="n">waveDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">redDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">waveDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">rootDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">redDir</span> <span class="o">+</span> <span class="s1">&#39;../&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">rootDir</span> <span class="o">+</span>
                                                   <span class="s1">&#39;clean/&#39;</span> <span class="o">+</span><span class="n">field</span><span class="o">+</span>
                                                   <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="n">wave</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">outroot</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">field</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cleanDir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">trimdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">rootDir</span> <span class="o">+</span>
                                                   <span class="s1">&#39;clean/&#39;</span> <span class="o">+</span> <span class="n">wave</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">outSuffix</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outroot</span> <span class="o">+=</span> <span class="n">outSuffix</span>

    <span class="c1"># This is the final output directory</span>
    <span class="n">comboDir</span> <span class="o">=</span> <span class="n">rootDir</span> <span class="o">+</span> <span class="s1">&#39;combo/&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">comboDir</span><span class="p">)</span>

    <span class="c1"># Make strings out of all the filename roots.</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">make_filenames</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># This is the output root filename</span>
    <span class="n">_out</span> <span class="o">=</span> <span class="n">comboDir</span> <span class="o">+</span> <span class="s1">&#39;mag&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span>
    <span class="n">_sub</span> <span class="o">=</span> <span class="n">comboDir</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wave</span>

    <span class="c1">##########</span>
    <span class="c1"># Determine if we are going to trim and/or weight the files</span>
    <span class="c1"># when combining. If so, then we need to determine the Strehl</span>
    <span class="c1"># and FWHM for each image. We check strehl source which shouldn&#39;t</span>
    <span class="c1"># be saturated. *** Hard coded to strehl source ***</span>
    <span class="c1">##########</span>

    <span class="c1"># Load Strehls and FWHM for sorting and trimming</span>
    <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span> <span class="o">=</span> <span class="n">loadStrehl</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">)</span>

    <span class="c1"># Default weights</span>
    <span class="c1"># Create an array with length equal to number of frames used,</span>
    <span class="c1"># and with all elements equal to 1/(# of files)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Trimming</span>
    <span class="c1">##########</span>
    <span class="k">if</span> <span class="n">trim</span><span class="p">:</span>
        <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">trim_on_fwhm</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span>
                                                     <span class="n">fwhm_max</span><span class="o">=</span><span class="n">fwhm_max</span><span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Weighting</span>
    <span class="c1">##########</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="s1">&#39;strehl&#39;</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weight_by_strehl</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">weight</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">weight</span> <span class="o">!=</span> <span class="s1">&#39;strehl&#39;</span><span class="p">)):</span>
        <span class="c1"># Assume weight is set to a filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weight</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Weights file does not exist, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">weight</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">readWeightsFile</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

    <span class="c1"># Determine the reference image</span>
    <span class="n">refImage</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: reference image - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">refImage</span><span class="p">)</span>

    <span class="c1">##########</span>
    <span class="c1"># Write out a log file. With a list of images in the</span>
    <span class="c1"># final combination.</span>
    <span class="c1">##########</span>
    <span class="n">combine_log</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">strehls</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

    <span class="c1"># See if all images are at same PA, if not, rotate all to PA = 0</span>
    <span class="c1"># temporarily. This needs to be done to get correct shifts.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling combine_rotation&#39;</span><span class="p">)</span>
    <span class="n">diffPA</span> <span class="o">=</span> <span class="n">combine_rotation</span><span class="p">(</span><span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

    <span class="c1"># Make a table of initial guesses for the shifts.</span>
    <span class="c1"># Use the header keywords AOTSX and AOTSY to get shifts.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling mosaic_ref&#39;</span><span class="p">)</span>
    <span class="n">mosaic_ref</span><span class="p">(</span><span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.init.shifts&#39;</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

    <span class="c1"># Keep record of files that went into this combine</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling combine_lis&#39;</span><span class="p">)</span>
    <span class="n">combine_lis</span><span class="p">(</span><span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.lis&#39;</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">)</span>

    <span class="c1"># Register images to get shifts.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling mosaic_register&#39;</span><span class="p">)</span>
    <span class="n">shiftsTab</span> <span class="o">=</span> <span class="n">mosaic_register</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">)</span>

    <span class="c1"># Determine the size of the output image from max shifts</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling mosaic_size&#39;</span><span class="p">)</span>
    <span class="n">xysize</span> <span class="o">=</span> <span class="n">mosaic_size</span><span class="p">(</span><span class="n">shiftsTab</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">_out</span><span class="p">,</span> <span class="n">_sub</span><span class="p">,</span> <span class="n">submaps</span><span class="p">)</span>

    <span class="c1"># Combine all the images together.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling mosaic_drizzle&#39;</span><span class="p">)</span>
    <span class="n">combine_drizzle</span><span class="p">(</span><span class="n">xysize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">_out</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">shiftsTab</span><span class="p">,</span>
                    <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span> <span class="n">fixDAR</span><span class="o">=</span><span class="n">fixDAR</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>

    <span class="c1"># Now make submaps</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">submaps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">combine_submaps</span><span class="p">(</span><span class="n">xysize</span><span class="p">,</span> <span class="n">cleanDir</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">_sub</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span>
                        <span class="n">shiftsTab</span><span class="p">,</span> <span class="n">submaps</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">,</span>
                        <span class="n">fixDAR</span><span class="o">=</span><span class="n">fixDAR</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskSubmap</span><span class="p">)</span>

    <span class="c1"># Remove *.lis_r file &amp; rotated rcoo files, if any - these</span>
    <span class="c1"># were just needed to get the proper shifts for xregister</span>
    <span class="n">_lisr</span> <span class="o">=</span> <span class="n">_out</span> <span class="o">+</span> <span class="s1">&#39;.lis_r&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_lisr</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)):</span>
        <span class="n">_rcoo</span> <span class="o">=</span> <span class="n">cleanDir</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.rcoo&#39;</span>
        <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">_rcoo</span><span class="p">])</span></div>



<div class="viewcode-block" id="mosaic_register">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.mosaic_register">[docs]</a>
<span class="k">def</span> <span class="nf">mosaic_register</span><span class="p">(</span><span class="n">outroot</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">diffPA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register images for a mosaic. This only calculates the exact</span>
<span class="sd">    shifts between each image... it doesn&#39;t do the combining.</span>

<span class="sd">    @param outroot: The root for the output image. The resulting</span>
<span class="sd">    shifts will be written into a file called &lt;outroot&gt;.shifts</span>
<span class="sd">    @type outroot: string</span>
<span class="sd">    @param refImage: The name of the reference image.</span>
<span class="sd">    @type refImage: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shiftFile</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.shifts&#39;</span>
    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">([</span><span class="n">shiftFile</span><span class="p">])</span>

    <span class="c1"># xregister parameters</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">immatch</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">unlearn</span><span class="p">(</span><span class="s1">&#39;xregister&#39;</span><span class="p">)</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.init.shifts&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">append</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">databasefmt</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">correlation</span> <span class="o">=</span> <span class="s1">&#39;fourier&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">xwindow</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="o">.</span><span class="n">ywindow</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: registering images&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">diffPA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.lis_r&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.lis&#39;</span>

    <span class="n">regions</span> <span class="o">=</span> <span class="s1">&#39;[*,*]&#39;</span>
    <span class="n">ir</span><span class="o">.</span><span class="n">xregister</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">shiftFile</span><span class="p">)</span>

    <span class="c1"># Read in the shifts file. Column format is:</span>
    <span class="c1"># Filename.fits  xshift  yshift</span>
    <span class="n">shiftsTable</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">shiftFile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">header_start</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">shiftsTable</span><span class="p">)</span></div>



<div class="viewcode-block" id="mosaic_size">
<a class="viewcode-back" href="../../../autoapi/kai/reduce/data/index.html#kai.reduce.data.mosaic_size">[docs]</a>
<span class="k">def</span> <span class="nf">mosaic_size</span><span class="p">(</span><span class="n">shiftsTable</span><span class="p">,</span> <span class="n">refImage</span><span class="p">,</span> <span class="n">outroot</span><span class="p">,</span> <span class="n">subroot</span><span class="p">,</span> <span class="n">submaps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the final size for the completed mosaic.</span>

<span class="sd">    @params shiftsTable: Table from mosaic_register containing the</span>
<span class="sd">    shifts for all the images.</span>
<span class="sd">    @type shiftsTable: string</span>
<span class="sd">    @param refImage: The first image used as  reference.</span>
<span class="sd">    @type refImage: string</span>
<span class="sd">    @param outroot: The root name for the resulting output file.</span>
<span class="sd">    @type outroot: string</span>
<span class="sd">    @param subroot:</span>
<span class="sd">    @type subroot: string</span>
<span class="sd">    @param submaps:</span>
<span class="sd">    @type submaps:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_allShifts</span> <span class="o">=</span> <span class="n">shiftsTable</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span>
    <span class="n">y_allShifts</span> <span class="o">=</span> <span class="n">shiftsTable</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]</span>

    <span class="n">xhi</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_allShifts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">xlo</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_allShifts</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">yhi</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_allShifts</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">ylo</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_allShifts</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="c1"># Make sure to include the edges of all images.</span>
    <span class="c1"># Might require some extra padding on one side.</span>
    <span class="n">maxoffset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xlo</span><span class="p">,</span> <span class="n">xhi</span><span class="p">,</span> <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span><span class="p">])</span>

    <span class="n">orig_img</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
    <span class="n">orig_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_img</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">padd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">orig_size</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">))</span>

    <span class="n">xref</span> <span class="o">=</span> <span class="n">x_allShifts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yref</span> <span class="o">=</span> <span class="n">y_allShifts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xref</span> <span class="o">=</span> <span class="n">xref</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>
    <span class="n">yref</span> <span class="o">=</span> <span class="n">yref</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>

    <span class="c1"># Read in 16C&#39;s position in the ref image and translate</span>
    <span class="c1"># it into the coordinates of the final main and sub maps.</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">refImage</span><span class="p">,</span><span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xrefSrc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;XREF&#39;</span><span class="p">])</span>
    <span class="n">yrefSrc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;YREF&#39;</span><span class="p">])</span>

    <span class="n">xrefSrc</span> <span class="o">=</span> <span class="n">xrefSrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>
    <span class="n">yrefSrc</span> <span class="o">=</span> <span class="n">yrefSrc</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span>

    <span class="n">cooMain</span> <span class="o">=</span> <span class="p">[</span><span class="n">outroot</span> <span class="o">+</span> <span class="s1">&#39;.coo&#39;</span><span class="p">]</span>
    <span class="n">cooSubs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.coo&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subroot</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">submaps</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">cooAll</span> <span class="o">=</span> <span class="n">cooMain</span> <span class="o">+</span> <span class="n">cooSubs</span>

    <span class="n">util</span><span class="o">.</span><span class="n">rmall</span><span class="p">(</span><span class="n">cooAll</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">coo</span> <span class="ow">in</span> <span class="n">cooAll</span><span class="p">:</span>
        <span class="n">_allCoo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">coo</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.3f</span><span class="s1"> </span><span class="si">%9.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xrefSrc</span><span class="p">,</span> <span class="n">yrefSrc</span><span class="p">))</span>
        <span class="n">_allCoo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">xysize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">orig_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">maxoffset</span> <span class="o">+</span> <span class="n">padd</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;combine: Size of output image is </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xysize</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xysize</span></div>

    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, J. R. Lu, A. K. Gautam, T. Do.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>